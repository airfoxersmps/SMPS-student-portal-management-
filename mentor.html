<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMPS Tech | Mentor Command Hub</title>
    <!-- Premium Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- 3D Engine -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* Theme Variables - Light & Dark Modes - Aesthetic Theme */
        :root {
            /* Light Mode - Bright & Clean */
            --primary-light: #6366F1;
            --primary-dark: #4F46E5;
            --primary-soft: #818CF8;
            --primary-glow: rgba(99, 102, 241, 0.25);
            --bg-light: #F9FAFB;
            --bg-dark: #111827;
            --surface-light: #FFFFFF;
            --surface-dark: #1F2937;
            --text-light: #1F2937;
            --text-dark: #F3F4F6;
            --text-muted-light: #6B7280;
            --text-muted-dark: #9CA3AF;
            --border-light: #E5E7EB;
            --border-dark: #374151;
            --card-bg-light: #FFFFFF;
            --card-bg-dark: #1F2937;
            --sidebar-bg-light: rgba(255, 255, 255, 0.98);
            --sidebar-bg-dark: rgba(17, 24, 39, 0.98);
            --hover-light: #F3F4F6;
            --hover-dark: #374151;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --info: #3B82F6;
            --accent-1: #8B5CF6;
            --accent-2: #EC4899;

            /* Current theme (default light) */
            --primary: var(--primary-light);
            --bg: var(--bg-light);
            --surface: var(--surface-light);
            --text: var(--text-light);
            --text-muted: var(--text-muted-light);
            --border: var(--border-light);
            --card-bg: var(--card-bg-light);
            --sidebar-bg: var(--sidebar-bg-light);
            --hover-bg: var(--hover-light);

            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
        }

        /* Dark Mode */
        [data-theme="dark"] {
            --primary: var(--primary-light);
            --bg: #111827;
            --surface: #1F2937;
            --text: #F3F4F6;
            --text-muted: #9CA3AF;
            --border: #374151;
            --card-bg: #1F2937;
            --sidebar-bg: rgba(17, 24, 39, 0.98);
            --hover-bg: #374151;

            /* Shadows for dark mode */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.4);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.4);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            outline: none;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: var(--bg);
            color: var(--text);
            overflow: hidden;
            height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }

        #canvas-container {
            position: fixed;
            inset: 0;
            z-index: -1;
            background: radial-gradient(circle at 20% 30%, var(--bg), var(--surface));
            opacity: 0.7;
        }

        /* Theme Toggle Button - Aesthetic */
        .theme-toggle {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 60px;
            padding: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--text);
            transition: 0.3s;
            margin-left: 15px;
            box-shadow: var(--shadow-md);
        }

        .theme-toggle:hover {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px var(--primary-glow);
            transform: scale(1.05);
        }

        .theme-toggle i {
            font-size: 1.2rem;
            padding: 6px 10px;
            border-radius: 40px;
            transition: 0.3s;
        }

        .theme-toggle .fa-sun {
            color: #F59E0B;
        }

        .theme-toggle .fa-moon {
            color: #6366F1;
        }

        [data-theme="light"] .theme-toggle .fa-sun {
            background: rgba(245, 158, 11, 0.15);
        }

        [data-theme="dark"] .theme-toggle .fa-moon {
            background: rgba(99, 102, 241, 0.15);
        }

        /* ----- LOGIN VIEW ----- */
        #view-login {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at top right, var(--bg-dark), var(--bg));
            z-index: 5000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .login-card {
            background: var(--surface);
            padding: 50px;
            border-radius: 50px;
            width: 100%;
            max-width: 440px;
            text-align: center;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-xl);
        }

        /* ----- CORE LAYOUT ----- */
        #view-portal {
            display: flex;
            height: 100vh;
            position: relative;
            z-index: 100;
            overflow: hidden;
        }

        .sidebar {
            width: 300px;
            padding: 30px 20px;
            background: var(--sidebar-bg);
            backdrop-filter: blur(30px);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            height: 100%;
            box-shadow: 10px 0 30px rgba(0, 0, 0, 0.05);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 800;
            font-size: 1.4rem;
            letter-spacing: -0.5px;
            color: var(--text);
            margin-bottom: 40px;
            padding-left: 10px;
        }

        .logo i {
            color: var(--primary);
            font-size: 2rem;
            filter: drop-shadow(0 4px 6px var(--primary-glow));
        }

        .nav-label {
            font-size: 10px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 25px 0 10px 15px;
        }

        .sidebar-link {
            padding: 14px 20px;
            border-radius: 16px;
            color: var(--text-muted);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: 0.3s;
            margin-bottom: 5px;
            font-size: 0.95rem;
            border: 1px solid transparent;
        }

        .sidebar-link:hover {
            background: var(--hover-bg);
            color: var(--text);
            border-color: var(--border);
        }

        .sidebar-link.active {
            background: linear-gradient(135deg, var(--primary), var(--accent-1));
            color: #fff;
            box-shadow: 0 10px 20px var(--primary-glow);
        }

        .workspace {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            background: var(--bg);
        }

        /* ----- COMPONENTS ----- */
        .bento-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 24px;
            margin-bottom: 30px;
        }

        .card {
            padding: 25px;
            border-radius: 32px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-md);
        }

        .card:hover {
            border-color: var(--primary);
            transform: translateY(-6px);
            box-shadow: var(--shadow-xl);
        }

        .info-label {
            font-size: 10px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            display: block;
        }

        .info-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text);
            letter-spacing: -0.5px;
        }

        /* Table Styles */
        .table-wrap {
            background: var(--card-bg);
            border-radius: 32px;
            border: 1px solid var(--border);
            overflow: hidden;
            margin-top: 20px;
            box-shadow: var(--shadow-md);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 18px 20px;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            border-bottom: 1.5px solid var(--border);
            background: var(--surface);
        }

        td {
            padding: 16px 20px;
            font-size: 13px;
            font-weight: 500;
            border-bottom: 1px solid var(--border);
            color: var(--text);
        }

        /* Buttons */
        .btn-p {
            background: linear-gradient(135deg, var(--primary), var(--accent-1));
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 8px 16px var(--primary-glow);
        }

        .btn-p:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 25px var(--primary-glow);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 10px;
            border-radius: 30px;
        }

        .mark-btn {
            width: 36px;
            height: 36px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            color: #fff;
            transition: 0.2s;
            font-size: 14px;
        }

        .btn-yes {
            background: var(--success);
        }

        .btn-yes:hover {
            background: #059669;
            transform: scale(1.1);
        }

        .btn-no {
            background: var(--danger);
        }

        .btn-no:hover {
            background: #DC2626;
            transform: scale(1.1);
        }

        .btn-warning {
            background: var(--warning);
        }

        .btn-warning:hover {
            background: #D97706;
            transform: scale(1.1);
        }

        /* Badges */
        .badge {
            padding: 4px 12px;
            border-radius: 40px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            display: inline-block;
        }

        .bg-e {
            background: rgba(16, 185, 129, 0.15);
            color: #10B981;
        }

        .bg-a {
            background: rgba(245, 158, 11, 0.15);
            color: #F59E0B;
        }

        .bg-p {
            background: rgba(99, 102, 241, 0.15);
            color: #6366F1;
        }

        .bg-warning {
            background: rgba(245, 158, 11, 0.15);
            color: #F59E0B;
        }

        /* Point Grid */
        .points-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 6px;
            margin: 15px 0;
        }

        .point-node {
            aspect-ratio: 1;
            border-radius: 10px;
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            transition: 0.2s;
        }

        .point-node.pending {
            background: var(--warning);
            border-color: var(--warning);
            color: white;
            animation: pulse 1.5s infinite;
        }

        .point-node.approved {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .point-node.none {
            background: var(--surface);
            color: var(--text-muted);
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }

            100% {
                opacity: 1;
            }
        }

        /* Asset Items */
        .asset-item {
            padding: 16px;
            background: var(--surface);
            border-radius: 24px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: 0.3s;
            margin-bottom: 12px;
        }

        .asset-item:hover {
            border-color: var(--primary);
            transform: translateX(6px);
            box-shadow: var(--shadow-md);
        }

        .asset-item a {
            font-size: 13px;
            font-weight: 600;
            color: var(--primary);
            text-decoration: none;
            word-break: break-all;
        }

        .asset-meta {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            display: flex;
            justify-content: space-between;
        }

        /* Checkbox List */
        .check-list {
            max-height: 250px;
            overflow-y: auto;
            background: var(--surface);
            border: 1.5px solid var(--border);
            border-radius: 20px;
            padding: 12px;
            margin-top: 10px;
        }

        .check-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: 0.2s;
        }

        .check-item:hover {
            background: var(--hover-bg);
            border-radius: 12px;
        }

        .check-item:last-child {
            border-bottom: none;
        }

        .check-item input {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .check-item label {
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            flex: 1;
            color: var(--text);
        }

        /* Modal */
        .modal-bg {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            z-index: 6000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-bg.active {
            display: flex;
        }

        .modal-card {
            background: var(--surface);
            width: 100%;
            max-width: 600px;
            border-radius: 50px;
            padding: 40px;
            max-height: 85vh;
            overflow-y: auto;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-xl);
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 16px;
            border-radius: 40px;
            border: 1.5px solid var(--border);
            font-weight: 500;
            outline: none;
            background: var(--surface);
            color: var(--text);
            margin-top: 8px;
            transition: 0.3s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px var(--primary-glow);
        }

        /* Ticker */
        .ticker-wrap {
            position: fixed;
            top: 0;
            width: 100%;
            height: 44px;
            background: var(--surface);
            backdrop-filter: blur(12px);
            color: var(--text);
            z-index: 1100;
            display: flex;
            align-items: center;
            overflow: hidden;
            font-size: 11px;
            font-weight: 600;
            border-bottom: 1px solid var(--border);
            letter-spacing: 0.5px;
            box-shadow: var(--shadow-md);
        }

        .ticker-move {
            display: flex;
            white-space: nowrap;
            animation: ticker-scroll 60s linear infinite;
            gap: 4rem;
        }

        .ticker-move span i {
            color: var(--primary);
            margin-right: 8px;
        }

        @keyframes ticker-scroll {
            0% {
                transform: translateX(100%);
            }

            100% {
                transform: translateX(-100%);
            }
        }

        /* Chat Hub */
        .chat-hub {
            display: grid;
            grid-template-columns: 280px 1fr;
            height: calc(100vh - 160px);
            background: var(--card-bg);
            border-radius: 40px;
            overflow: hidden;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-xl);
        }

        .chat-list {
            background: var(--surface);
            border-right: 1px solid var(--border);
            padding: 25px 15px;
            overflow-y: auto;
        }

        .chat-user {
            padding: 16px 18px;
            border-radius: 20px;
            margin-bottom: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
            color: var(--text-muted);
            border: 1px solid transparent;
        }

        .chat-user:hover {
            background: var(--hover-bg);
            color: var(--text);
            border-color: var(--border);
        }

        .chat-user.active {
            background: linear-gradient(135deg, var(--primary), var(--accent-1));
            color: white;
        }

        .chat-main {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-msgs {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            background: var(--bg);
        }

        .bubble {
            font-size: 0.95rem;
            font-weight: 500;
            padding: 16px 22px;
            border-radius: 24px;
            max-width: 70%;
            line-height: 1.6;
            animation: bubble-entry 0.3s ease-out forwards;
        }

        @keyframes bubble-entry {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .bubble-me {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--primary), var(--accent-1));
            color: #fff;
            border-bottom-right-radius: 8px;
        }

        .bubble-them {
            align-self: flex-start;
            background: var(--surface);
            border: 1px solid var(--border);
            border-bottom-left-radius: 8px;
            color: var(--text);
        }

        /* Student Cards */
        .student-card {
            background: var(--surface);
            border-radius: 24px;
            padding: 20px;
            border: 1px solid var(--border);
            transition: 0.3s;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .student-card:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .student-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .student-name {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--text);
        }

        .student-srn {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 600;
        }

        .student-stats {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .stat-item {
            flex: 1;
            text-align: center;
            padding: 8px;
            background: var(--bg);
            border-radius: 16px;
        }

        .stat-value {
            font-weight: 700;
            font-size: 1rem;
            color: var(--primary);
        }

        .stat-label {
            font-size: 9px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* Project Stats */
        .project-stats {
            display: flex;
            gap: 15px;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .stat-badge {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 4px 12px;
            border-radius: 40px;
            background: var(--bg);
            border: 1px solid var(--border);
            font-size: 11px;
            font-weight: 600;
        }

        .hidden {
            display: none !important;
        }

        #loader {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s cubic-bezier(0.4, 0, 0.2, 1) infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Progress Bar */
        .progress-track {
            height: 8px;
            background: var(--border);
            border-radius: 20px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), #34D399);
            border-radius: 20px;
            transition: width 0.5s ease;
        }

        /* Score Display */
        .score-display {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--primary);
            text-align: center;
        }

        .score-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Responsive */
        @media screen and (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                height: 100vh;
                z-index: 2000;
                transform: translateX(-100%);
                width: 85%;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .bento-grid {
                grid-template-columns: 1fr;
            }

            .chat-hub {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body data-theme="light">

    <div id="canvas-container"></div>

    <div id="loader">
        <div class="spinner"></div>
    </div>

    <div id="ticker-bar" class="ticker-wrap">
        <div class="ticker-move">
            <span><i class="fas fa-shield"></i> SYSTEM STATUS: COMMAND HUB V6.1 DEPLOYED</span>
            <span><i class="fas fa-bolt"></i> FACULTY UPDATE: DYNAMIC POINT SCALE NOW OPERATIONAL</span>
            <span><i class="fas fa-sync"></i> PROTOCOL: APPROVE STUDENT POINTS TO UPDATE SCORES</span>
            <span><i class="fas fa-users"></i> MY STUDENTS: DIRECT ACCESS TO ASSIGNED NODES</span>
        </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="view-login">
        <div class="login-card">
            <i class="fas fa-shield-halved" style="font-size: 4rem; color: var(--primary); margin-bottom: 25px;"></i>
            <h2 style="font-weight: 700; letter-spacing: -1px; font-size: 2.2rem;">Command Node</h2>
            <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 35px; font-weight: 500;">Authorized
                Mentor Identification Required</p>
            <form id="login-form">
                <input type="text" id="l-user" placeholder="Mentor Username / Email" required
                    style="border-radius:40px; padding:18px 25px; margin-bottom:15px;">
                <input type="password" id="l-pass" placeholder="Authorization Token" required
                    style="border-radius:40px; padding:18px 25px; margin-bottom:30px;">
                <button type="submit" class="btn-p"
                    style="width:100%; height:60px; justify-content:center; border-radius:50px; font-size:13px;">Launch
                    HUB</button>
            </form>
            <p id="login-error" style="color: var(--danger); font-size: 12px; margin-top: 20px; font-weight: 600;"
                class="hidden"><i class="fas fa-circle-exclamation"></i> ACCESS_DENIED: NODE MISMATCH</p>
        </div>
    </div>

    <!-- MAIN PORTAL -->
    <div id="view-portal" class="hidden">
        <aside class="sidebar">
            <div class="logo">
                <i class="fas fa-shield-halved"></i><span>SMPS <b>Command</b></span>
            </div>

            <!-- Theme Toggle in Sidebar -->
            <div style="display: flex; justify-content: flex-end; margin-bottom: 10px; padding-right: 10px;">
                <div class="theme-toggle" onclick="App.toggleTheme()">
                    <i class="fas fa-sun"></i>
                    <i class="fas fa-moon"></i>
                </div>
            </div>

            <nav style="flex: 1;">
                <div class="nav-label">Executive</div>
                <div onclick="App.switchTab('dashboard')" id="nav-dashboard" class="sidebar-link active">
                    <i class="fas fa-grid-2"></i> Station Home
                </div>
                <div onclick="App.switchTab('my-students')" id="nav-my-students" class="sidebar-link">
                    <i class="fas fa-users"></i> My Students
                </div>
                <div onclick="App.switchTab('attendance')" id="nav-attendance" class="sidebar-link">
                    <i class="fas fa-calendar-check"></i> Attendance
                </div>
                <div onclick="App.switchTab('teambuilder')" id="nav-teambuilder" class="sidebar-link">
                    <i class="fas fa-users-gear"></i> Team Builder
                </div>

                <div class="nav-label">Asset Command</div>
                <div onclick="App.switchTab('assethub')" id="nav-assethub" class="sidebar-link">
                    <i class="fas fa-magnifying-glass"></i> Node Assets
                </div>
                <div onclick="App.switchTab('tasks')" id="nav-tasks" class="sidebar-link">
                    <i class="fas fa-list-check"></i> Directives
                </div>
                <div onclick="App.switchTab('sync')" id="nav-sync" class="sidebar-link">
                    <i class="fas fa-message"></i> Sync Hub
                </div>
                <div onclick="App.switchTab('broadcast')" id="nav-broadcast" class="sidebar-link">
                    <i class="fas fa-bullhorn"></i> Transmissions
                </div>
            </nav>

            <div
                style="margin-top: auto; padding: 20px; background: var(--surface); border-radius: 24px; border: 1px solid var(--border);">
                <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px;">
                    <div id="u-avatar" class="avatar-circle"
                        style="width:45px; height:45px; background: linear-gradient(135deg, var(--primary), var(--accent-1)); border-radius: 16px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1.2rem;">
                        M</div>
                    <div style="overflow:hidden;">
                        <p id="u-name" style="font-size: 13px; font-weight: 700; color: var(--text);">Mentor</p>
                        <span class="badge bg-e" style="font-size: 8px; padding: 3px 8px;">DATA SYNC ACTIVE</span>
                    </div>
                </div>
                <button onclick="location.reload()"
                    style="width:100%; background:none; border:1px solid rgba(239,68,68,0.3); padding:12px; border-radius:16px; font-size:11px; font-weight:600; cursor:pointer; color:var(--danger); transition:0.3s;">TERMINATE
                    SESSION</button>
            </div>
        </aside>

        <main class="workspace">
            <header style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 40px;">
                <div>
                    <h2 id="view-title" style="font-size: 2.6rem; font-weight: 700; letter-spacing: -1.5px;">Command
                        Station</h2>
                    <p id="live-clock"
                        style="font-size: 1.1rem; font-weight: 600; color: var(--primary); margin-top: 5px;">00:00:00 AM
                    </p>
                </div>
                <div style="text-align: right;">
                    <span class="badge bg-p" style="padding:8px 20px; border-radius:40px;">CORE_NODE_V6.1</span>
                </div>
            </header>

            <!-- DASHBOARD -->
            <div id="tab-dashboard">
                <div class="bento-grid">
                    <div class="card">
                        <span class="info-label">Assigned Nodes</span>
                        <div class="info-value" id="stat-students">0</div>
                    </div>
                    <div class="card">
                        <span class="info-label">Active Clusters</span>
                        <div class="info-value" id="stat-teams">0</div>
                    </div>
                    <div class="card">
                        <span class="info-label">Pending Approvals</span>
                        <div class="info-value" id="stat-pending" style="color:var(--warning);">0</div>
                    </div>
                    <div class="card">
                        <span class="info-label">Global Directives</span>
                        <div class="info-value" id="stat-feed">0</div>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:28px;">
                    <div class="card">
                        <h4 style="font-weight:700; font-size:1.2rem; margin-bottom:20px; letter-spacing:-0.5px;">
                            Student Ledger Pulse</h4>
                        <div id="dash-roster" style="display:flex; flex-direction:column; gap:12px;"></div>
                    </div>
                    <div class="card">
                        <h4 style="font-weight:700; font-size:1.2rem; margin-bottom:20px; letter-spacing:-0.5px;">
                            Pending Approvals</h4>
                        <div id="dash-pending" style="display:flex; flex-direction:column; gap:12px;"></div>
                    </div>
                </div>
            </div>

            <!-- MY STUDENTS - NEW TAB -->
            <div id="tab-my-students" class="hidden">
                <h2 style="font-size: 2.6rem; font-weight: 700; margin-bottom: 30px; letter-spacing: -1.5px;">
                    <i class="fas fa-users" style="margin-right: 15px; color: var(--primary);"></i>My Students
                </h2>
                <div id="my-students-grid"
                    style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 24px;">
                </div>
            </div>

            <!-- ATTENDANCE -->
            <div id="tab-attendance" class="hidden">
                <h2 style="font-size: 2.6rem; font-weight: 700; margin-bottom: 30px; letter-spacing: -1.5px;">
                    <i class="fas fa-calendar-check" style="margin-right: 15px; color: var(--primary);"></i>Attendance
                    Verification
                </h2>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>SRN</th>
                                <th>Node Identity</th>
                                <th>Last Sync</th>
                                <th>Status</th>
                                <th>Verification</th>
                            </tr>
                        </thead>
                        <tbody id="att-table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- TEAM BUILDER - FIXED with dynamic points -->
            <div id="tab-teambuilder" class="hidden">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
                    <h3 style="font-weight:700; font-size:1.8rem; letter-spacing:-1px;">Dual-Track Cluster Control</h3>
                    <button class="btn-p" onclick="App.showModal('project')"><i class="fas fa-plus"></i> Initialize
                        Cluster</button>
                </div>
                <div id="teams-container" style="display:grid; grid-template-columns: 1fr 1fr; gap:28px;"></div>
            </div>

            <!-- ASSET HUB -->
            <div id="tab-assethub" class="hidden">
                <h2 style="font-size: 2.6rem; font-weight: 700; margin-bottom: 30px; letter-spacing: -1.5px;">
                    <i class="fas fa-magnifying-glass" style="margin-right: 15px; color: var(--primary);"></i>Node
                    Assets
                </h2>
                <div class="card" style="margin-bottom: 25px; border-left: 8px solid var(--primary);">
                    <span class="info-label">Technical Submission Explorer</span>
                    <p style="font-size:13px; color:var(--text-muted); margin-bottom:15px;">Select a student node to
                        aggregate all historical research anchors and directive payloads.</p>
                    <div style="display:flex; gap:15px; margin-top:10px;">
                        <select id="asset-student-picker"
                            style="flex:1; border-radius:40px; padding-left:25px;"></select>
                        <button onclick="App.exploreAssets()" class="btn-p"
                            style="border-radius:40px; padding:0 35px;">EXPLORE</button>
                    </div>
                </div>
                <div id="asset-results" class="hidden" style="margin-top:40px;">
                    <h3 id="asset-title" class="info-value"
                        style="font-size:1.8rem; margin-bottom:25px; letter-spacing:-1px;">Node Assets</h3>
                    <div id="asset-list-container" style="display:grid; grid-template-columns: 1fr 1fr; gap:24px;">
                    </div>
                </div>
            </div>

            <!-- DIRECTIVES (TASKS) -->
            <div id="tab-tasks" class="hidden">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
                    <h3 style="font-weight:700; font-size:1.8rem; letter-spacing:-1px;">Instruction Payload Dispatch
                    </h3>
                    <button class="btn-p" onclick="App.showModal('task')"><i class="fas fa-bolt"></i> Dispatch
                        Directive</button>
                </div>
                <div id="tasks-grid"
                    style="display:grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap:24px;"></div>
            </div>

            <!-- SYNC HUB (CHAT) -->
            <div id="tab-sync" class="hidden">
                <h2 style="font-size: 2.6rem; font-weight: 700; margin-bottom: 30px; letter-spacing: -1.5px;">
                    <i class="fas fa-message" style="margin-right: 15px; color: var(--primary);"></i>Sync Hub
                </h2>
                <div class="chat-hub">
                    <aside class="chat-list" id="chat-roster"></aside>
                    <main class="chat-main">
                        <div id="chat-h"
                            style="padding: 20px 30px; border-bottom: 1px solid var(--border); font-weight: 700; color: var(--primary); font-size:1rem; display:flex; justify-content:space-between; align-items:center;">
                            <span id="chat-title-node">Support Sync Hub</span>
                            <span class="badge bg-e" style="font-size:9px;">P2P_STABLE</span>
                        </div>
                        <div id="chat-window" class="chat-msgs"></div>
                        <form id="chat-form"
                            style="padding: 20px 30px; border-top: 1px solid var(--border); display: flex; gap: 15px; background: var(--surface);">
                            <input type="text" id="chat-input" placeholder="Transmit packet..." required
                                style="flex:1; border-radius:40px; padding:15px 25px;">
                            <button type="submit" class="btn-p" style="padding:0 35px; border-radius:40px;"><i
                                    class="fas fa-paper-plane"></i></button>
                        </form>
                    </main>
                </div>
            </div>

            <!-- BROADCAST -->
            <div id="tab-broadcast" class="hidden">
                <h2 style="font-size: 2.6rem; font-weight: 700; margin-bottom: 30px; letter-spacing: -1.5px;">
                    <i class="fas fa-bullhorn" style="margin-right: 15px; color: var(--primary);"></i>Transmissions
                </h2>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px;">
                    <div class="card">
                        <span class="info-label">Inbound Payloads: Admin Control</span>
                        <div id="notif-inbound" style="margin-top:20px; display:flex; flex-direction:column; gap:15px;">
                        </div>
                    </div>
                    <div class="card">
                        <span class="info-label">Outbound: Transmit Mentor Broadcast</span>
                        <textarea id="b-text" placeholder="Enter directive payload..."
                            style="height:150px; border-radius:24px; padding:20px;"></textarea>
                        <button onclick="App.sendBroadcast()" class="btn-p"
                            style="width:100%; margin-top:20px; height:55px; justify-content:center; border-radius:20px;">Deploy
                            Transmission</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAL -->
    <div id="modal-bg" class="modal-bg" onclick="if(event.target===this) App.closeModal()">
        <div class="modal-card">
            <div id="modal-content"></div>
        </div>
    </div>

    <!-- FIREBASE SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, addDoc, updateDoc, deleteDoc, serverTimestamp, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBN4o8oj-6DhJb51sGGrcyS8d9SDX7HKWk",
            authDomain: "students-management-2ec78.firebaseapp.com",
            projectId: "students-management-2ec78",
            storageBucket: "students-management-2ec78.firebasestorage.app",
            messagingSenderId: "649634574508",
            appId: "1:649634574508:web:d856dbe5bcc112fde0ef09"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'smps-v1';

        const ui = {
            set: (id, val) => { const el = document.getElementById(id); if (el) el.innerText = val; },
            html: (id, val) => { const el = document.getElementById(id); if (el) el.innerHTML = val; },
            toggle: (id, isVisible) => { const el = document.getElementById(id); if (el) el.classList.toggle('hidden', !isVisible); }
        };

        const App = {
            state: {
                user: null,
                students: [],
                projects: [],
                tasks: [],
                notifications: [],
                chats: [],
                activeChat: null,
                currentTab: 'dashboard'
            },

            async init() {
                this.init3D();

                // Load saved theme preference
                const savedTheme = localStorage.getItem('theme') || 'light';
                document.body.setAttribute('data-theme', savedTheme);
                this.updateThemeToggle(savedTheme);

                setInterval(() => {
                    document.getElementById('live-clock').innerText = new Date().toLocaleTimeString('en-US', {
                        hour12: true,
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                }, 1000);

                await signInAnonymously(auth);

                setTimeout(() => {
                    document.getElementById('loader').classList.add('hidden');
                }, 1000);

                document.getElementById('login-form').onsubmit = (e) => this.handleLogin(e);
                document.getElementById('chat-form').onsubmit = (e) => this.sendChat(e);
                window.App = this;
            },

            toggleTheme() {
                const currentTheme = document.body.getAttribute('data-theme');
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                document.body.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                this.updateThemeToggle(newTheme);
            },

            updateThemeToggle(theme) {
                const sunIcon = document.querySelector('.theme-toggle .fa-sun');
                const moonIcon = document.querySelector('.theme-toggle .fa-moon');
                if (theme === 'light') {
                    sunIcon.style.opacity = '1';
                    moonIcon.style.opacity = '0.5';
                } else {
                    sunIcon.style.opacity = '0.5';
                    moonIcon.style.opacity = '1';
                }
            },

            async handleLogin(e) {
                e.preventDefault();
                const u = document.getElementById('l-user').value.trim();
                const p = document.getElementById('l-pass').value;
                const btn = e.target.querySelector('button');
                btn.innerText = 'SYNCING NODE...';

                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'mentors'), snap => {
                    const match = snap.docs.find(d => (d.data().email === u || d.data().name === u) && d.data().spec === p);
                    if (match) {
                        this.state.user = { id: match.id, ...match.data() };
                        this.enterPortal();
                    } else {
                        document.getElementById('login-error').classList.remove('hidden');
                        btn.innerText = 'AUTHORIZE HUB';
                    }
                }, { once: true });
            },

            enterPortal() {
                document.getElementById('view-login').classList.add('hidden');
                document.getElementById('view-portal').classList.remove('hidden');
                document.getElementById('u-name').innerText = this.state.user.name;
                document.getElementById('u-avatar').innerText = this.state.user.name[0];
                this.sync();
            },

            sync() {
                const targets = ['students', 'projects', 'tasks', 'notifications', 'chats'];
                targets.forEach(col => {
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', col), snap => {
                        this.state[col] = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        this.render();
                    });
                });
            },

            switchTab(t) {
                this.state.currentTab = t;
                document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));

                const tabEl = document.getElementById(`tab-${t}`);
                const navEl = document.getElementById(`nav-${t}`);

                if (tabEl) tabEl.classList.remove('hidden');
                if (navEl) navEl.classList.add('active');

                let title = t === 'teambuilder' ? 'Team Builder' :
                    t === 'broadcast' ? 'Transmissions' :
                        t === 'assethub' ? 'Asset Hub' :
                            t === 'my-students' ? 'My Students' :
                                t.charAt(0).toUpperCase() + t.slice(1).replace('hub', ' Hub');
                document.getElementById('view-title').innerText = title;

                this.render();
            },

            render() {
                const { user, students, projects, tasks, notifications, chats, currentTab } = this.state;
                if (!user) return;

                // Filter data for this mentor
                const myStudents = students.filter(s => s.mentor === user.email);
                const myProjects = projects.filter(p => p.mentor === user.email);
                const myTasks = tasks.filter(t => myStudents.some(s => s.id === t.sid || s.srn === t.sid));

                // Calculate pending approvals across all projects
                const totalPending = myProjects.reduce((sum, p) => {
                    const points = p.points || [];
                    return sum + points.filter(pt => pt.status === 'pending').length;
                }, 0);

                // Update stats
                document.getElementById('stat-students').innerText = myStudents.length;
                document.getElementById('stat-teams').innerText = myProjects.length;
                document.getElementById('stat-pending').innerText = totalPending;
                document.getElementById('stat-feed').innerText = notifications.length;

                // DASHBOARD
                if (currentTab === 'dashboard') {
                    ui.html('dash-roster', myStudents.slice(0, 5).map(s => `
                        <div style="padding:15px; background:var(--surface); border-radius:20px; border:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
                            <span style="font-weight:700; font-size:13px; color:var(--text);">${s.name}</span>
                            <span class="badge ${s.att === 'verified' ? 'bg-e' : 'bg-a'}">${s.att || 'offline'}</span>
                        </div>`).join('') || '<p class="info-label">No nodes mapped.</p>');

                    // Show pending approvals in dashboard
                    const pendingItems = [];
                    myProjects.forEach(p => {
                        const points = p.points || [];
                        points.forEach((pt, idx) => {
                            if (pt.status === 'pending') {
                                pendingItems.push({ project: p, pointIndex: idx });
                            }
                        });
                    });

                    ui.html('dash-pending', pendingItems.slice(0, 5).map(item => `
                        <div style="padding:15px; background:var(--surface); border-radius:20px; border:1px solid var(--border);">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                                <span class="badge bg-warning">PENDING</span>
                                <small style="font-weight:600;">${item.project.teamName}</small>
                            </div>
                            <p style="font-size:12px; font-weight:600;">Point ${item.pointIndex + 1} requires approval</p>
                            <button onclick="App.approvePoint('${item.project.id}', ${item.pointIndex})" class="btn-p btn-sm" style="margin-top:8px; width:100%;">
                                <i class="fas fa-check"></i> Approve
                            </button>
                        </div>
                    `).join('') || '<p class="info-label">No pending approvals.</p>');
                }

                // MY STUDENTS - Detailed view with project points
                if (currentTab === 'my-students') {
                    ui.html('my-students-grid', myStudents.map(s => {
                        const studentProjects = projects.filter(p => p.members?.includes(s.name));
                        const studentTasks = tasks.filter(t => t.sid === s.id || t.sid === s.srn);
                        const completedTasks = studentTasks.filter(t => t.status === 'Done').length;

                        // Calculate total approved points across all projects for this student
                        let totalApproved = 0;
                        let totalPoints = 0;
                        studentProjects.forEach(p => {
                            const points = p.points || [];
                            totalApproved += points.filter(pt => pt.status === 'approved').length;
                            totalPoints += p.totalPoints || points.length || 0;
                        });
                        const avgScore = totalPoints > 0 ? Math.round((totalApproved / totalPoints) * 100) : 0;

                        return `
                            <div class="student-card">
                                <div class="student-header">
                                    <span class="student-name">${s.name}</span>
                                    <span class="student-srn">${s.srn}</span>
                                </div>
                                <div class="badge ${s.att === 'verified' ? 'bg-e' : 'bg-a'}" style="align-self: flex-start;">${s.att || 'offline'}</div>
                                
                                <div class="student-stats">
                                    <div class="stat-item">
                                        <div class="stat-value">${studentProjects.length}</div>
                                        <div class="stat-label">Projects</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-value">${completedTasks}</div>
                                        <div class="stat-label">Tasks Done</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-value">${avgScore}</div>
                                        <div class="stat-label">Avg Score</div>
                                    </div>
                                </div>
                                
                                <div class="progress-track">
                                    <div class="progress-fill" style="width: ${((s.attendanceCount || 0) / 30 * 100) || 0}%"></div>
                                </div>
                                
                                <div style="display:flex; gap:10px; margin-top:10px;">
                                    <button onclick="App.openChat('${s.id}', '${s.name}')" class="btn-p" style="flex:1; padding:10px; font-size:10px;">
                                        <i class="fas fa-message"></i> Message
                                    </button>
                                    <button onclick="App.viewStudentAssets('${s.id}')" class="btn-p" style="flex:1; padding:10px; font-size:10px; background: var(--surface); color: var(--primary);">
                                        <i class="fas fa-folder-open"></i> Assets
                                    </button>
                                </div>

                                ${studentProjects.length > 0 ? `
                                    <div style="margin-top:15px;">
                                        <span class="info-label">Active Projects</span>
                                        ${studentProjects.map(p => {
                            const points = p.points || [];
                            const pending = points.filter(pt => pt.status === 'pending').length;
                            const approved = points.filter(pt => pt.status === 'approved').length;
                            const total = p.totalPoints || points.length || 0;
                            return `
                                                <div style="background:var(--bg); padding:12px; border-radius:16px; margin-top:8px;">
                                                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                                                        <span style="font-weight:600; font-size:12px;">${p.teamName}</span>
                                                        <span class="badge ${pending > 0 ? 'bg-warning' : 'bg-e'}">${approved}/${total}</span>
                                                    </div>
                                                    ${pending > 0 ? `
                                                        <button onclick="App.switchTab('teambuilder')" class="btn-p btn-sm" style="width:100%; margin-top:5px; padding:8px;">
                                                            <i class="fas fa-clock"></i> ${pending} pending approval
                                                        </button>
                                                    ` : ''}
                                                </div>
                                            `;
                        }).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('') || '<p class="info-label" style="text-align:center; padding:50px;">No students assigned yet.</p>');
                }

                // ATTENDANCE
                if (currentTab === 'attendance') {
                    ui.html('att-table-body', myStudents.map(s => `
                        <tr>
                            <td><b style="font-weight:700;">${s.srn}</b></td>
                            <td>${s.name}</td>
                            <td>${s.time || '--:--'}</td>
                            <td><span class="badge ${s.att === 'verified' ? 'bg-e' : 'bg-a'}">${s.att || 'offline'}</span></td>
                            <td>
                                <div style="display:flex; gap:8px;">
                                    <button onclick="App.setAtt('${s.id}','verified')" class="mark-btn btn-yes"><i class="fas fa-check"></i></button>
                                    <button onclick="App.setAtt('${s.id}','absent')" class="mark-btn btn-no"><i class="fas fa-times"></i></button>
                                </div>
                            </td>
                        </tr>`).join(''));
                }

                // TEAM BUILDER - FIXED with dynamic points and approval buttons
                if (currentTab === 'teambuilder') {
                    ui.html('teams-container', myProjects.map(p => {
                        // Get points array
                        const points = p.points || [];
                        const totalPoints = p.totalPoints || points.length || 0;

                        // Calculate counts
                        const approvedPoints = points.filter(pt => pt.status === 'approved').length;
                        const pendingPoints = points.filter(pt => pt.status === 'pending').length;

                        // Calculate score based on formula
                        const calculatedScore = totalPoints > 0 ? Math.round((approvedPoints / totalPoints) * 100) : 0;

                        return `
                            <div class="card">
                                <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:20px;">
                                    <div>
                                        <h4 style="font-weight:700; font-size:1.4rem; letter-spacing:-0.5px;">${p.teamName}</h4>
                                        <span class="badge bg-p" style="margin-top:5px;">${p.track || 'Track'}</span>
                                    </div>
                                    <button onclick="App.deleteItem('projects','${p.id}')" style="background:none; border:none; color:var(--danger); cursor:pointer; font-size:1.2rem;">
                                        <i class="fas fa-trash-can"></i>
                                    </button>
                                </div>
                                
                                <p class="info-label" style="margin-bottom:5px;">Research Track</p>
                                <p style="font-size:13px; font-weight:600; color:var(--text); margin-bottom:20px;">${p.name}</p>
                                
                                <div style="margin-bottom:20px;">
                                    <span class="info-label">Team Members</span>
                                    <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:10px;">
                                        ${p.members?.map(m => `<span class="badge bg-p" style="padding:6px 12px;">${m}</span>`).join('') || 'None'}
                                    </div>
                                </div>
                                
                                <div class="project-stats">
                                    <span class="stat-badge"><i class="fas fa-chart-line"></i> Total: ${totalPoints}</span>
                                    <span class="stat-badge"><i class="fas fa-check-circle" style="color:var(--success);"></i> Approved: ${approvedPoints}</span>
                                    <span class="stat-badge"><i class="fas fa-clock" style="color:var(--warning);"></i> Pending: ${pendingPoints}</span>
                                </div>
                                
                                <div style="text-align: center; margin: 15px 0;">
                                    <span class="score-display">${calculatedScore}</span>
                                    <span class="score-label">/100</span>
                                </div>
                                
                                ${pendingPoints > 0 ? `
                                    <div style="margin:20px 0;">
                                        <span class="info-label">Pending Approvals</span>
                                        <div class="points-grid">
                                            ${points.map((pt, i) => {
                            if (pt.status === 'pending') {
                                return `
                                                        <div class="point-node pending" title="Point ${i + 1} - Click to approve" 
                                                             onclick="App.approvePoint('${p.id}', ${i})">
                                                            ${i + 1}
                                                        </div>
                                                    `;
                            }
                            return '';
                        }).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:20px;">
                                    <div>
                                        <span class="info-label">Total Points (Number of Boxes)</span>
                                        <input type="number" id="score-${p.id}" value="${totalPoints}" min="1" max="200" style="margin-top:5px; height:50px;">
                                        <p style="font-size:10px; color:var(--text-muted); margin-top:5px;">Change this number to add/remove boxes</p>
                                    </div>
                                    <div>
                                        <span class="info-label">Points Progress</span>
                                        <div style="background:var(--bg); padding:10px; border-radius:15px; margin-top:5px;">
                                            <div class="progress-track">
                                                <div class="progress-fill" style="width: ${(approvedPoints / totalPoints * 100) || 0}%"></div>
                                            </div>
                                            <p style="font-size:11px; text-align:center; margin-top:8px;">${approvedPoints}/${totalPoints} approved</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom:20px;">
                                    <span class="info-label">Protocol Reference (PDF)</span>
                                    <input type="file" id="pdf-file-${p.id}" accept=".pdf" style="margin-top:5px; height:50px; font-size:11px; padding:12px;">
                                    <p id="pdf-status-${p.id}" style="font-size:11px; font-weight:600; color:var(--success); margin-top:8px;">
                                        ${p.pdfFileName ? 'ACTIVE: ' + p.pdfFileName : 'No PDF uploaded'}
                                    </p>
                                    ${p.pdfUrl ? `<a href="${p.pdfUrl}" target="_blank" style="font-size:11px; color:var(--primary);">View Current PDF</a>` : ''}
                                </div>
                                
                                <button onclick="App.updateCluster('${p.id}')" class="btn-p" style="width:100%; margin-top:10px; height:50px; justify-content:center; border-radius:15px;">
                                    SYNCHRONIZE TRACK PROGRESS
                                </button>
                            </div>
                        `;
                    }).join('') || '<p class="info-label" style="grid-column: span 2; text-align:center; padding:50px;">No active team clusters initialized.</p>');
                }

                // ASSET HUB
                if (currentTab === 'assethub') {
                    const picker = document.getElementById('asset-student-picker');
                    const currentVal = picker.value;
                    picker.innerHTML = `<option value="">Select Student Node...</option>` +
                        myStudents.map(s => `<option value="${s.id}" ${s.id === currentVal ? 'selected' : ''}>${s.name} (${s.srn})</option>`).join('');
                }

                // TASKS
                if (currentTab === 'tasks') {
                    ui.html('tasks-grid', myTasks.map(t => {
                        const s = students.find(x => x.id === t.sid || x.srn === t.sid);
                        return `
                            <div class="card" style="border-left: 6px solid ${t.status === 'Done' ? 'var(--success)' : 'var(--warning)'}">
                                <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:15px;">
                                    <span class="badge ${t.status === 'Done' ? 'bg-e' : 'bg-a'}">${t.status}</span>
                                    <small style="font-weight:600; color:var(--text-muted);">Due: ${t.due}</small>
                                </div>
                                <h4 style="font-weight:700; font-size:14px; margin-bottom:15px;">${t.desc}</h4>
                                <p style="font-size:12px; font-weight:600; color:var(--primary); margin-bottom:15px;">Assigned to: ${s?.name || 'Unknown'}</p>
                                ${t.payload ? `<a href="${t.payload}" target="_blank" style="font-size:11px; color:var(--success); display:block; margin-bottom:15px;">View Submission</a>` : ''}
                                <button onclick="App.deleteItem('tasks','${t.id}')" style="width:100%; background:none; border:1px solid rgba(239,68,68,0.3); padding:12px; border-radius:12px; font-size:11px; font-weight:600; color:var(--danger); cursor:pointer;">
                                    PURGE DIRECTIVE
                                </button>
                            </div>
                        `;
                    }).join('') || '<p class="info-label" style="grid-column: span 3; text-align:center; padding:50px;">Directive queue clear.</p>');
                }

                // SYNC HUB
                if (currentTab === 'sync') {
                    ui.html('chat-roster', myStudents.map(s => `
                        <div onclick="App.openChat('${s.id}', '${s.name}')" class="chat-user ${this.state.activeChat === s.id ? 'active' : ''}">
                            <i class="fas fa-user-graduate" style="margin-right:10px;"></i> ${s.name}
                        </div>`).join(''));
                    this.renderSyncWindow();
                }

                // BROADCAST
                if (currentTab === 'broadcast') {
                    const inbound = notifications.filter(n => n.senderRole === 'Admin' || n.senderRole === 'Super Admin');
                    ui.html('notif-inbound', inbound.map(n => `
                        <div class="card" style="margin-bottom:15px; padding:20px; border-left:4px solid var(--warning);">
                            <div style="display:flex; justify-content:space-between;">
                                <span class="badge bg-a">${n.senderRole}</span>
                                <small style="font-weight:600; color:var(--text-muted);">${n.time}</small>
                            </div>
                            <p style="font-weight:700; margin-top:10px;">${n.from}</p>
                            <p style="font-size:13px; color:var(--text-muted); margin-top:5px; line-height:1.5;">${n.text}</p>
                        </div>`).join('') || '<p class="info-label">No command syncs.</p>');
                }
            },

            async approvePoint(projId, pointIndex) {
                const proj = this.state.projects.find(p => p.id === projId);
                if (!proj) return;

                const points = proj.points ? [...proj.points] : [];

                if (pointIndex < points.length && points[pointIndex].status === 'pending') {
                    points[pointIndex] = { status: 'approved' };

                    // Calculate new score based on approved points
                    const approvedCount = points.filter(pt => pt.status === 'approved').length;
                    const totalPoints = proj.totalPoints || points.length;
                    const calculatedScore = Math.round((approvedCount / totalPoints) * 100);

                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'projects', projId), {
                        points,
                        cumulativeScore: calculatedScore
                    });

                    alert(` Point ${pointIndex + 1} approved. New score: ${calculatedScore}/100`);
                }
            },

            viewStudentAssets(studentId) {
                this.switchTab('assethub');
                setTimeout(() => {
                    document.getElementById('asset-student-picker').value = studentId;
                    this.exploreAssets();
                }, 100);
            },

            exploreAssets() {
                const sid = document.getElementById('asset-student-picker').value;
                if (!sid) return;

                const s = this.state.students.find(x => x.id === sid);
                if (!s) return;

                const taskLinks = this.state.tasks.filter(t => (t.sid === sid || t.sid === s.srn) && t.payload);
                const projLinks = this.state.projects.filter(p => p.members?.includes(s.name) && p.driveLink);

                document.getElementById('view-title').innerText = `Node Assets: ${s.name}`;
                document.getElementById('asset-results').classList.remove('hidden');

                let html = '';
                if (projLinks.length > 0) {
                    html += `<div class="card" style="grid-column: span 2;">
                        <span class="info-label">Project Technical Deliverables</span>
                        ${projLinks.map(p => {
                        const points = p.points || [];
                        const approved = points.filter(pt => pt.status === 'approved').length;
                        const total = p.totalPoints || points.length;
                        return `
                                <div class="asset-item">
                                    <a href="${p.driveLink}" target="_blank">${p.driveLink}</a>
                                    <span class="asset-meta">${p.teamName}  Score: ${approved}/${total}</span>
                                </div>
                            `;
                    }).join('')}
                    </div>`;
                }
                if (taskLinks.length > 0) {
                    html += `<div class="card" style="grid-column: span 2;">
                        <span class="info-label">Task Payload Submissions</span>
                        ${taskLinks.map(t => `
                            <div class="asset-item">
                                <a href="${t.payload}" target="_blank">${t.payload}</a>
                                <span class="asset-meta">${t.desc.slice(0, 50)}...  ${t.status}</span>
                            </div>
                        `).join('')}
                    </div>`;
                }
                if (html === '') {
                    html = '<p class="info-label" style="text-align:center; padding:50px; grid-column: span 2; background:var(--surface); border-radius:24px; border:1px solid var(--border);">No technical assets synchronized for this node identity.</p>';
                }
                ui.html('asset-list-container', html);
            },

            showModal(type) {
                const bg = document.getElementById('modal-bg');
                const content = document.getElementById('modal-content');
                const myStudents = this.state.students.filter(s => s.mentor === this.state.user.email);
                bg.classList.add('active');

                if (type === 'project') {
                    content.innerHTML = `
                        <h3 style="font-weight:700; font-size:1.8rem; margin-bottom:20px;">Initialize Team Cluster</h3>
                        
                        <label class="info-label">Domain Track</label>
                        <select id="m-p-track">
                            <option>Track Alpha</option>
                            <option>Track Beta</option>
                            <option>Track Gamma</option>
                        </select>
                        
                        <label class="info-label" style="margin-top:15px;">Cluster Identity Name</label>
                        <input type="text" id="m-p-team" placeholder="e.g. CYBER_UNIT_01">
                        
                        <label class="info-label" style="margin-top:15px;">Research Roadmap Title</label>
                        <input type="text" id="m-p-name" placeholder="Smart Energy Matrix v6">
                        
                        <label class="info-label" style="margin-top:15px;">Total Points (Number of Boxes)</label>
                        <input type="number" id="m-p-total-points" value="40" min="1" max="200" placeholder="Enter total points">
                        
                        <label class="info-label" style="margin-top:15px;">Assign Individual Node Members</label>
                        <div class="check-list">
                            ${myStudents.map((s, i) => `
                                <div class="check-item">
                                    <input type="checkbox" id="node-${i}" value="${s.name}">
                                    <label for="node-${i}">${s.name} (${s.srn})</label>
                                </div>
                            `).join('')}
                        </div>
                        
                        <button onclick="App.addProject()" class="btn-p" style="width:100%; margin-top:25px; height:55px; justify-content:center; border-radius:20px;">
                            Deploy Cluster
                        </button>`;
                } else if (type === 'task') {
                    content.innerHTML = `
                        <h3 style="font-weight:700; font-size:1.8rem; margin-bottom:20px;">Dispatch Technical Directive</h3>
                        
                        <label class="info-label">Target Node</label>
                        <select id="m-t-sid">
                            ${myStudents.map(s => `<option value="${s.id}">${s.name} (${s.srn})</option>`).join('')}
                        </select>
                        
                        <label class="info-label" style="margin-top:15px;">Instruction Payload</label>
                        <textarea id="m-t-desc" placeholder="Details..." style="height:100px;"></textarea>
                        
                        <label class="info-label" style="margin-top:15px;">Deadline Time</label>
                        <input type="text" id="m-t-due" placeholder="Today 5:00 PM">
                        
                        <button onclick="App.addTask()" class="btn-p" style="width:100%; margin-top:25px; height:55px; justify-content:center; border-radius:20px;">
                            Transmit Directive
                        </button>`;
                }
            },

            closeModal() {
                document.getElementById('modal-bg').classList.remove('active');
            },

            async addProject() {
                const track = document.getElementById('m-p-track').value;
                const teamName = document.getElementById('m-p-team').value;
                const name = document.getElementById('m-p-name').value;
                const totalPoints = parseInt(document.getElementById('m-p-total-points').value) || 40;
                const members = Array.from(document.querySelectorAll('.check-item input:checked')).map(c => c.value);

                if (!name || !teamName || members.length === 0) {
                    alert("Missing cluster parameters.");
                    return;
                }

                // Initialize with dynamic number of points
                const points = Array(totalPoints).fill().map(() => ({ status: 'none' }));

                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'projects'), {
                    track,
                    teamName,
                    name,
                    members,
                    mentor: this.state.user.email,
                    points: points,
                    totalPoints: totalPoints,
                    pdfUrl: '',
                    pdfFileName: '',
                    cumulativeScore: 0,
                    driveLink: ''
                });

                this.closeModal();
            },

            async addTask() {
                const sid = document.getElementById('m-t-sid').value;
                const desc = document.getElementById('m-t-desc').value;
                const due = document.getElementById('m-t-due').value;
                if (!desc) return;

                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'tasks'), {
                    sid,
                    desc,
                    due,
                    status: 'Pending'
                });

                this.closeModal();
            },

            // FIXED: updateCluster now properly resizes the points array
            async updateCluster(projId) {
                const newTotalPoints = parseInt(document.getElementById(`score-${projId}`).value) || 0;
                const fileInput = document.getElementById(`pdf-file-${projId}`);

                // Get current project
                const proj = this.state.projects.find(p => p.id === projId);
                if (!proj) return;

                // Get current points array
                let currentPoints = proj.points || [];
                let updateData = {};

                // Handle points array resizing based on new total
                if (newTotalPoints > 0) {
                    let newPoints = [...currentPoints];

                    if (newTotalPoints > currentPoints.length) {
                        // Add new points (e.g., from 24 to 45)
                        for (let i = currentPoints.length; i < newTotalPoints; i++) {
                            newPoints.push({ status: 'none' });
                        }
                    } else if (newTotalPoints < currentPoints.length) {
                        // Remove extra points if reducing (e.g., from 45 to 30)
                        newPoints = newPoints.slice(0, newTotalPoints);
                    }

                    // Calculate new score based on approved points in resized array
                    const approvedCount = newPoints.filter(pt => pt.status === 'approved').length;
                    const calculatedScore = newTotalPoints > 0 ? Math.round((approvedCount / newTotalPoints) * 100) : 0;

                    updateData = {
                        points: newPoints,
                        totalPoints: newTotalPoints,
                        cumulativeScore: calculatedScore
                    };
                }

                // Handle PDF upload if any
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    updateData.pdfFileName = file.name;

                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        updateData.pdfUrl = e.target.result;
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'projects', projId), updateData);
                        alert(` Cluster synchronized! Now has ${newTotalPoints} points. Score: ${updateData.cumulativeScore}/100`);
                    };
                    reader.readAsDataURL(file);
                } else {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'projects', projId), updateData);
                    alert(` Cluster synchronized! Now has ${newTotalPoints} points. Score: ${updateData.cumulativeScore}/100`);
                }
            },

            async setAtt(id, val) {
                const time = new Date().toLocaleTimeString('en-US', { hour12: true, hour: '2-digit', minute: '2-digit' });
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', id), {
                    att: val,
                    time,
                    ...(val === 'verified' ? { attendanceCount: (this.state.students.find(s => s.id === id)?.attendanceCount || 0) + 1 } : {})
                });
            },

            async deleteItem(col, id) {
                if (confirm("Permanently purge this record from technical ledger?")) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', col, id));
                }
            },

            async sendBroadcast() {
                const text = document.getElementById('b-text').value;
                if (!text) return;

                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'notifications'), {
                    from: this.state.user.name,
                    senderRole: 'Mentor',
                    text,
                    time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                });

                document.getElementById('b-text').value = '';
                alert(" TRANSMISSION_SUCCESS");
            },

            openChat(id, name) {
                this.state.activeChat = id;
                document.getElementById('chat-title-node').innerHTML = `<i class="fas fa-user-graduate" style="margin-right:8px;"></i> ${name}`;
                this.renderSyncWindow();
                this.render();
            },

            renderSyncWindow() {
                const win = document.getElementById('chat-window');
                if (!win || !this.state.activeChat) return;

                const msgs = this.state.chats.filter(c => c.channel === this.state.activeChat || c.channel === this.state.user.id);

                win.innerHTML = msgs.map(m => `
                    <div class="bubble ${m.sender === 'Mentor' ? 'bubble-me' : 'bubble-them'}">
                        ${m.text}
                        <span class="bubble-time" style="font-size:8px; display:block; margin-top:5px; opacity:0.7;">
                            ${m.timestamp ? new Date(m.timestamp.seconds * 1000).toLocaleTimeString() : ''}
                        </span>
                    </div>
                `).join('') || '<p class="info-label" style="text-align:center; padding:30px;">Sync established. Start conversation.</p>';

                win.scrollTop = win.scrollHeight;
            },

            async sendChat(e) {
                e.preventDefault();
                const inp = document.getElementById('chat-input');
                if (!inp.value || !this.state.activeChat) return;

                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chats'), {
                    channel: this.state.activeChat,
                    text: inp.value,
                    sender: 'Mentor',
                    timestamp: serverTimestamp()
                });

                inp.value = '';
            },

            init3D() {
                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                document.getElementById('canvas-container').appendChild(renderer.domElement);

                const geometry = new THREE.SphereGeometry(0.8, 32, 32);
                const material = new THREE.MeshPhongMaterial({
                    color: 0x6366F1,
                    transparent: true,
                    opacity: 0.08
                });

                const bubbles = [];
                for (let i = 0; i < 40; i++) {
                    const sphere = new THREE.Mesh(geometry, material);
                    sphere.position.set(
                        (Math.random() - 0.5) * 200,
                        (Math.random() - 0.5) * 200,
                        (Math.random() - 0.5) * 200
                    );
                    sphere.userData = {
                        v: new THREE.Vector3(
                            (Math.random() - 0.5) * 0.02,
                            (Math.random() - 0.5) * 0.02,
                            (Math.random() - 0.5) * 0.02
                        )
                    };
                    scene.add(sphere);
                    bubbles.push(sphere);
                }

                scene.add(new THREE.AmbientLight(0xffffff, 0.9));
                camera.position.z = 100;

                const animate = () => {
                    requestAnimationFrame(animate);
                    bubbles.forEach(b => {
                        b.position.add(b.userData.v);
                        if (Math.abs(b.position.x) > 100) b.userData.v.x *= -1;
                        if (Math.abs(b.position.y) > 100) b.userData.v.y *= -1;
                        if (Math.abs(b.position.z) > 100) b.userData.v.z *= -1;
                    });
                    renderer.render(scene, camera);
                };
                animate();
            }
        };

        window.App = App;
        window.onload = () => App.init();
    </script>
</body>

</html>
