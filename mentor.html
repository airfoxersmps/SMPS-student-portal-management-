<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMPS Tech | Mentor Command Hub</title>
    <!-- Premium Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- 3D Engine -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- THEME VARIABLES - PRO OPTIMIZED --- */
        :root {
            --primary-light: #6366F1;
            --primary-dark: #4F46E5;
            --primary-soft: #818CF8;
            --primary-glow: rgba(99, 102, 241, 0.25);
            --bg-light: #F9FAFB;
            --bg-dark: #111827;
            --surface-light: #FFFFFF;
            --surface-dark: #1F2937;
            --text-light: #1F2937;
            --text-dark: #F3F4F6;
            --text-muted-light: #6B7280;
            --text-muted-dark: #9CA3AF;
            --border-light: #E5E7EB;
            --border-dark: #374151;
            --card-bg-light: #FFFFFF;
            --card-bg-dark: #1F2937;
            --sidebar-bg-light: rgba(255, 255, 255, 0.98);
            --sidebar-bg-dark: rgba(17, 24, 39, 0.98);
            --hover-light: #F3F4F6;
            --hover-dark: #374151;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --info: #3B82F6;
            --accent-1: #8B5CF6;
            --accent-2: #EC4899;

            --primary: var(--primary-light);
            --bg: var(--bg-light);
            --surface: var(--surface-light);
            --text: var(--text-light);
            --text-muted: var(--text-muted-light);
            --border: var(--border-light);
            --card-bg: var(--card-bg-light);
            --sidebar-bg: var(--sidebar-bg-light);
            --hover-bg: var(--hover-light);

            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
        }

        [data-theme="dark"] {
            --primary: var(--primary-light);
            --bg: #111827;
            --surface: #1F2937;
            --text: #F3F4F6;
            --text-muted: #9CA3AF;
            --border: #374151;
            --card-bg: #1F2937;
            --sidebar-bg: rgba(17, 24, 39, 0.98);
            --hover-bg: #374151;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.4);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.4);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.5);
        }

        /* --- GLOBAL RESET --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            outline: none;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: var(--bg);
            color: var(--text);
            overflow: hidden;
            height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }

        #canvas-container {
            position: fixed;
            inset: 0;
            z-index: -1;
            background: radial-gradient(circle at 20% 30%, var(--bg), var(--surface));
            opacity: 0.7;
        }

        /* --- UI ELEMENTS --- */
        .theme-toggle {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 60px;
            padding: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--text);
            transition: 0.3s;
            margin-left: 15px;
            box-shadow: var(--shadow-md);
        }

        .theme-toggle:hover {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px var(--primary-glow);
            transform: scale(1.05);
        }

        .theme-toggle i {
            font-size: 1.2rem;
            padding: 6px 10px;
            border-radius: 40px;
            transition: 0.3s;
        }

        .theme-toggle .fa-sun {
            color: #F59E0B;
        }

        .theme-toggle .fa-moon {
            color: #6366F1;
        }

        /* --- PORTAL LAYOUT --- */
        #view-login {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at top right, var(--bg-dark), var(--bg));
            z-index: 5000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .login-card {
            background: var(--surface);
            padding: 50px;
            border-radius: 50px;
            width: 100%;
            max-width: 440px;
            text-align: center;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-xl);
        }

        #view-portal {
            display: flex;
            height: 100vh;
            position: relative;
            z-index: 100;
            overflow: hidden;
        }

        .sidebar {
            width: 300px;
            padding: 30px 20px;
            background: var(--sidebar-bg);
            backdrop-filter: blur(30px);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            height: 100%;
            box-shadow: 10px 0 30px rgba(0, 0, 0, 0.05);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 800;
            font-size: 1.4rem;
            letter-spacing: -0.5px;
            color: var(--text);
            margin-bottom: 40px;
            padding-left: 10px;
        }

        .logo i {
            color: var(--primary);
            font-size: 2rem;
            filter: drop-shadow(0 4px 6px var(--primary-glow));
        }

        .nav-label {
            font-size: 10px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 25px 0 10px 15px;
        }

        .sidebar-link {
            padding: 14px 20px;
            border-radius: 16px;
            color: var(--text-muted);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: 0.3s;
            margin-bottom: 5px;
            font-size: 0.95rem;
            border: 1px solid transparent;
        }

        .sidebar-link:hover {
            background: var(--hover-bg);
            color: var(--text);
            border-color: var(--border);
        }

        .sidebar-link.active {
            background: linear-gradient(135deg, var(--primary), var(--accent-1));
            color: #fff;
            box-shadow: 0 10px 20px var(--primary-glow);
        }

        .workspace {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            background: var(--bg);
        }

        /* --- BENTO & CARDS --- */
        .bento-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 24px;
            margin-bottom: 30px;
        }

        .card {
            padding: 25px;
            border-radius: 32px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .card:hover {
            border-color: var(--primary);
            transform: translateY(-6px);
            box-shadow: var(--shadow-xl);
        }

        .info-label {
            font-size: 10px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            display: block;
        }

        .info-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text);
            letter-spacing: -0.5px;
        }

        /* --- ASSET ITEMS --- */
        .asset-item {
            padding: 12px 18px;
            background: var(--bg);
            border-radius: 18px;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            transition: 0.2s;
            margin-bottom: 8px;
        }

        .asset-item:hover {
            border-color: var(--primary);
            transform: translateX(4px);
            background: var(--surface);
        }

        .asset-item a {
            font-size: 12px;
            font-weight: 700;
            color: var(--primary);
            text-decoration: none;
            word-break: break-all;
            flex: 1;
        }

        .asset-item .del-btn {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            padding: 5px;
            opacity: 0.6;
            transition: 0.2s;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .asset-item .del-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        /* --- TABLES --- */
        .table-wrap {
            background: var(--card-bg);
            border-radius: 32px;
            border: 1px solid var(--border);
            overflow: hidden;
            margin-top: 20px;
            box-shadow: var(--shadow-md);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 18px 20px;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            border-bottom: 1.5px solid var(--border);
            background: var(--surface);
        }

        td {
            padding: 16px 20px;
            font-size: 13px;
            font-weight: 500;
            border-bottom: 1px solid var(--border);
            color: var(--text);
        }

        /* --- BUTTONS --- */
        .btn-p {
            background: linear-gradient(135deg, var(--primary), var(--accent-1));
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 8px 16px var(--primary-glow);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-p:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 25px var(--primary-glow);
        }

        .btn-p:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .mark-btn {
            width: 36px;
            height: 36px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            color: #fff;
            transition: 0.2s;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-yes {
            background: var(--success);
        }

        .btn-no {
            background: var(--danger);
        }

        /* --- MODAL --- */
        .modal-bg {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            z-index: 6000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-bg.active {
            display: flex;
        }

        .modal-card {
            background: var(--surface);
            width: 100%;
            max-width: 620px;
            border-radius: 40px;
            padding: 40px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-xl);
            position: relative;
        }

        /* --- PRO FORMS --- */
        input,
        select,
        textarea {
            width: 100%;
            padding: 16px 22px;
            border-radius: 40px;
            border: 2.5px solid var(--border);
            background: var(--bg);
            color: var(--text);
            font-weight: 600;
            font-size: 13px;
            transition: 0.3s;
            margin-top: 8px;
            margin-bottom: 15px;
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: var(--primary);
            background: var(--surface);
            box-shadow: 0 0 0 4px var(--primary-glow);
        }

        .check-list {
            background: var(--bg);
            border: 2.5px solid var(--border);
            border-radius: 24px;
            padding: 15px;
            max-height: 220px;
            overflow-y: auto;
            margin-top: 10px;
            margin-bottom: 20px;
        }

        .check-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: 0.2s;
        }

        .check-item:last-child {
            border-bottom: none;
        }

        .check-item:hover {
            background: var(--hover-bg);
            border-radius: 12px;
        }

        .check-item input {
            width: 20px;
            height: 20px;
            margin: 0;
            accent-color: var(--primary);
            cursor: pointer;
        }

        .check-item label {
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            flex: 1;
            color: var(--text);
        }

        /* --- STUDENT PRO CARDS --- */
        .student-pro-card {
            background: var(--surface);
            border-radius: 32px;
            padding: 26px;
            border: 1px solid var(--border);
            transition: 0.3s;
            position: relative;
        }

        .student-pro-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-lg);
        }

        .student-initials {
            width: 55px;
            height: 55px;
            border-radius: 18px;
            background: linear-gradient(135deg, var(--primary), var(--accent-1));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            font-size: 1.3rem;
            box-shadow: var(--shadow-md);
        }

        .student-info-row {
            display: flex;
            gap: 18px;
            align-items: center;
            margin-bottom: 22px;
        }

        .student-meta {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px dashed var(--border);
        }

        .meta-box {
            background: var(--bg);
            padding: 14px;
            border-radius: 18px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .meta-val {
            font-size: 16px;
            font-weight: 800;
            color: var(--primary);
            display: block;
        }

        .meta-lab {
            font-size: 9px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* --- UI UTILS --- */
        .badge {
            padding: 4px 12px;
            border-radius: 40px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            display: inline-block;
        }

        .bg-e {
            background: rgba(16, 185, 129, 0.15);
            color: #10B981;
        }

        .bg-a {
            background: rgba(245, 158, 11, 0.15);
            color: #F59E0B;
        }

        .bg-p {
            background: rgba(99, 102, 241, 0.15);
            color: #6366F1;
        }

        .points-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 6px;
            margin: 15px 0;
        }

        .point-node {
            aspect-ratio: 1;
            border-radius: 10px;
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
        }

        .point-node.pending {
            background: var(--warning);
            border-color: var(--warning);
            color: white;
            animation: pulse 1.5s infinite;
            cursor: pointer;
        }

        .point-node.approved {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }

            100% {
                opacity: 1;
            }
        }

        .hidden {
            display: none !important;
        }

        #loader {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* --- TICKER --- */
        .ticker-wrap {
            position: fixed;
            top: 0;
            width: 100%;
            height: 44px;
            background: var(--surface);
            backdrop-filter: blur(12px);
            color: var(--text);
            z-index: 1100;
            display: flex;
            align-items: center;
            overflow: hidden;
            font-size: 11px;
            font-weight: 700;
            border-bottom: 1px solid var(--border);
            letter-spacing: 0.5px;
            box-shadow: var(--shadow-md);
        }

        .ticker-move {
            display: flex;
            white-space: nowrap;
            animation: ticker-scroll 60s linear infinite;
            gap: 4rem;
        }

        @keyframes ticker-scroll {
            0% {
                transform: translateX(100%);
            }

            100% {
                transform: translateX(-100%);
            }
        }

        @media screen and (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                height: 100vh;
                z-index: 2000;
                transform: translateX(-100%);
                width: 85%;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .bento-grid {
                grid-template-columns: 1fr;
            }

            .workspace {
                padding: 25px;
            }
        }
    </style>
</head>

<body data-theme="light">

    <div id="canvas-container"></div>

    <div id="loader">
        <div class="spinner"></div>
    </div>

    <div id="ticker-bar" class="ticker-wrap">
        <div class="ticker-move">
            <span><i class="fas fa-shield"></i> SYSTEM STATUS: COMMAND HUB V6.4 ACTIVE</span>
            <span><i class="fas fa-bolt"></i> NODE SYNC: FULL STUDENT PROFILES INTEGRATED</span>
            <span><i class="fas fa-sync"></i> RESOURCE HUB: PERSISTENT MULTI-ASSET DISPATCH ENABLED</span>
        </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="view-login">
        <div class="login-card">
            <i class="fas fa-shield-halved" style="font-size: 4rem; color: var(--primary); margin-bottom: 25px;"></i>
            <h2 style="font-weight: 700; letter-spacing: -1px; font-size: 2.2rem;">Command Node</h2>
            <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 35px; font-weight: 500;">Authorized
                Mentor Identification Required</p>
            <form id="login-form">
                <input type="text" id="l-user" placeholder="Mentor Username / Email" required>
                <input type="password" id="l-pass" placeholder="Authorization Token" required>
                <button type="submit" class="btn-p"
                    style="width:100%; height:60px; justify-content:center; border-radius:50px; font-size:13px;">Launch
                    HUB</button>
            </form>
            <p id="login-error" style="color: var(--danger); font-size: 12px; margin-top: 20px; font-weight: 600;"
                class="hidden"><i class="fas fa-circle-exclamation"></i> ACCESS_DENIED: NODE MISMATCH</p>
        </div>
    </div>

    <!-- MAIN PORTAL -->
    <div id="view-portal" class="hidden">
        <aside class="sidebar">
            <div class="logo">
                <i class="fas fa-shield-halved"></i><span>SMPS <b>Command</b></span>
            </div>

            <div style="display: flex; justify-content: flex-end; margin-bottom: 10px; padding-right: 10px;">
                <div class="theme-toggle" onclick="App.toggleTheme()">
                    <i class="fas fa-sun"></i>
                    <i class="fas fa-moon"></i>
                </div>
            </div>

            <nav style="flex: 1;">
                <div class="nav-label">Executive</div>
                <div onclick="App.switchTab('dashboard')" id="nav-dashboard" class="sidebar-link active">
                    <i class="fas fa-grid-2"></i> Station Home
                </div>
                <div onclick="App.switchTab('my-students')" id="nav-my-students" class="sidebar-link">
                    <i class="fas fa-users"></i> My Students
                </div>
                <div onclick="App.switchTab('attendance')" id="nav-attendance" class="sidebar-link">
                    <i class="fas fa-calendar-check"></i> Attendance
                </div>
                <div onclick="App.switchTab('teambuilder')" id="nav-teambuilder" class="sidebar-link">
                    <i class="fas fa-users-gear"></i> Team Builder
                </div>

                <div class="nav-label">Asset Command</div>
                <div onclick="App.switchTab('resources')" id="nav-resources" class="sidebar-link">
                    <i class="fas fa-book"></i> Resource Library
                </div>
                <div onclick="App.switchTab('assethub')" id="nav-assethub" class="sidebar-link">
                    <i class="fas fa-magnifying-glass"></i> Node Assets
                </div>
                <div onclick="App.switchTab('tasks')" id="nav-tasks" class="sidebar-link">
                    <i class="fas fa-list-check"></i> Directives
                </div>
                <div onclick="App.switchTab('sync')" id="nav-sync" class="sidebar-link">
                    <i class="fas fa-message"></i> Sync Hub
                </div>
                <div onclick="App.switchTab('broadcast')" id="nav-broadcast" class="sidebar-link">
                    <i class="fas fa-bullhorn"></i> Transmissions
                </div>
            </nav>

            <div
                style="margin-top: auto; padding: 20px; background: var(--surface); border-radius: 24px; border: 1px solid var(--border);">
                <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px;">
                    <div id="u-avatar" class="avatar-circle"
                        style="width:45px; height:45px; background: linear-gradient(135deg, var(--primary), var(--accent-1)); border-radius: 16px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1.2rem;">
                        M</div>
                    <div>
                        <p id="u-name" style="font-size: 13px; font-weight: 700; color: var(--text);">Mentor</p>
                        <span class="badge bg-e" style="font-size: 8px; padding: 3px 8px;">DATA SYNC ACTIVE</span>
                    </div>
                </div>
                <button onclick="location.reload()"
                    style="width:100%; background:none; border:1px solid rgba(239,68,68,0.3); padding:12px; border-radius:16px; font-size:11px; font-weight:600; cursor:pointer; color:var(--danger);">TERMINATE
                    SESSION</button>
            </div>
        </aside>

        <main class="workspace">
            <header style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 40px;">
                <div>
                    <h2 id="view-title" style="font-size: 2.6rem; font-weight: 700; letter-spacing: -1.5px;">Command
                        Station</h2>
                    <p id="live-clock"
                        style="font-size: 1.1rem; font-weight: 600; color: var(--primary); margin-top: 5px;">00:00:00 AM
                    </p>
                </div>
                <div><span class="badge bg-p" style="padding:8px 20px; border-radius:40px;">CORE_NODE_V6.4</span></div>
            </header>

            <!-- DASHBOARD -->
            <div id="tab-dashboard">
                <div class="bento-grid">
                    <div class="card"><span class="info-label">Assigned Nodes</span>
                        <div class="info-value" id="stat-students">0</div>
                    </div>
                    <div class="card"><span class="info-label">Active Clusters</span>
                        <div class="info-value" id="stat-teams">0</div>
                    </div>
                    <div class="card"><span class="info-label">Pending Approvals</span>
                        <div class="info-value" id="stat-pending" style="color:var(--warning);">0</div>
                    </div>
                    <div class="card"><span class="info-label">Global Directives</span>
                        <div class="info-value" id="stat-feed">0</div>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:28px;">
                    <div class="card">
                        <h4>Student Ledger Pulse</h4>
                        <div id="dash-roster" style="display:flex; flex-direction:column; gap:12px; margin-top:15px;">
                        </div>
                    </div>
                    <div class="card">
                        <h4>Pending Approvals</h4>
                        <div id="dash-pending" style="display:flex; flex-direction:column; gap:12px; margin-top:15px;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- MY STUDENTS -->
            <div id="tab-my-students" class="hidden">
                <div id="my-students-grid"
                    style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 24px;">
                </div>
            </div>

            <!-- ATTENDANCE -->
            <div id="tab-attendance" class="hidden">
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>SRN</th>
                                <th>Node Identity</th>
                                <th>Last Sync</th>
                                <th>Status</th>
                                <th>Verification</th>
                            </tr>
                        </thead>
                        <tbody id="att-table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- TEAM BUILDER -->
            <div id="tab-teambuilder" class="hidden">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
                    <h3 style="font-weight:700; font-size:1.8rem; letter-spacing:-1px;">Track Cluster Control</h3>
                    <button class="btn-p" onclick="App.showModal('project')"><i class="fas fa-plus"></i> Initialize
                        Cluster</button>
                </div>
                <div id="teams-container" style="display:grid; grid-template-columns: 1fr 1fr; gap:28px;"></div>
            </div>

            <!-- RESOURCE LIBRARY -->
            <div id="tab-resources" class="hidden">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
                    <h3 style="font-weight:700; font-size:1.8rem; letter-spacing:-1px;">Global Resource Library</h3>
                    <button class="btn-p" onclick="App.showModal('resource')"><i class="fas fa-upload"></i> Upload
                        Resource</button>
                </div>
                <div class="card" style="margin-bottom:30px;">
                    <span class="info-label">Active Public Assets</span>
                    <div class="table-wrap" style="margin-top:10px; border-radius:20px;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Category</th>
                                    <th>Source</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="resources-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ASSET HUB -->
            <div id="tab-assethub" class="hidden">
                <div class="card" style="margin-bottom: 25px; border-left: 8px solid var(--primary);">
                    <span class="info-label">Technical Submission Explorer</span>
                    <div style="display:flex; gap:15px; margin-top:10px;">
                        <select id="asset-student-picker"
                            style="flex:1; border-radius:40px; padding-left:25px;"></select>
                        <button onclick="App.exploreAssets()" class="btn-p"
                            style="border-radius:40px; padding:0 35px;">EXPLORE</button>
                    </div>
                </div>
                <div id="asset-results" class="hidden" style="margin-top:40px;">
                    <div id="asset-list-container" style="display:grid; grid-template-columns: 1fr 1fr; gap:24px;">
                    </div>
                </div>
            </div>

            <!-- DIRECTIVES -->
            <div id="tab-tasks" class="hidden">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
                    <h3 style="font-weight:700; font-size:1.8rem;">Directive Payloads</h3>
                    <button class="btn-p" onclick="App.showModal('task')"><i class="fas fa-bolt"></i> Dispatch
                        Directive</button>
                </div>
                <div id="tasks-grid"
                    style="display:grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap:24px;"></div>
            </div>

            <!-- SYNC HUB -->
            <div id="tab-sync" class="hidden">
                <div class="chat-hub">
                    <aside class="chat-list" id="chat-roster"></aside>
                    <main class="chat-main">
                        <div id="chat-h"
                            style="padding: 20px 30px; border-bottom: 1px solid var(--border); font-weight: 700; color: var(--primary); display:flex; justify-content:space-between; align-items:center;">
                            <span id="chat-title-node">Support Sync Hub</span>
                            <span class="badge bg-e">P2P_STABLE</span>
                        </div>
                        <div id="chat-window" class="chat-msgs"></div>
                        <form id="chat-form"
                            style="padding: 20px 30px; border-top: 1px solid var(--border); display: flex; gap: 15px; background: var(--surface);">
                            <input type="text" id="chat-input" placeholder="Transmit packet..." required
                                style="flex:1; border-radius:40px; padding:15px 25px;">
                            <button type="submit" class="btn-p" style="padding:0 35px; border-radius:40px;"><i
                                    class="fas fa-paper-plane"></i></button>
                        </form>
                    </main>
                </div>
            </div>

            <!-- BROADCAST -->
            <div id="tab-broadcast" class="hidden">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px;">
                    <div class="card"><span class="info-label">Inbound Admin Signals</span>
                        <div id="notif-inbound" style="margin-top:20px; display:flex; flex-direction:column; gap:15px;">
                        </div>
                    </div>
                    <div class="card">
                        <span class="info-label">Mentor Broadcast Payload</span>
                        <textarea id="b-text" placeholder="Enter directive payload..."
                            style="height:150px; border-radius:24px; padding:20px;"></textarea>
                        <button onclick="App.sendBroadcast()" class="btn-p"
                            style="width:100%; margin-top:20px; height:55px; justify-content:center; border-radius:20px;">Deploy
                            Transmission</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAL CONTAINER -->
    <div id="modal-bg" class="modal-bg" onclick="if(event.target===this) App.closeModal()">
        <div class="modal-card">
            <div id="modal-content"></div>
        </div>
    </div>

    <!-- FIREBASE INTEGRATION -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, addDoc, updateDoc, deleteDoc, serverTimestamp, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBN4o8oj-6DhJb51sGGrcyS8d9SDX7HKWk",
            authDomain: "students-management-2ec78.firebaseapp.com",
            projectId: "students-management-2ec78",
            storageBucket: "students-management-2ec78.firebasestorage.app",
            messagingSenderId: "649634574508",
            appId: "1:649634574508:web:d856dbe5bcc112fde0ef09"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'smps-v1';

        const ui = {
            set: (id, val) => { const el = document.getElementById(id); if (el) el.innerText = val; },
            html: (id, val) => { const el = document.getElementById(id); if (el) el.innerHTML = val; },
            toggle: (id, isVisible) => { const el = document.getElementById(id); if (el) el.classList.toggle('hidden', !isVisible); }
        };

        const App = {
            state: {
                user: null,
                students: [],
                projects: [],
                tasks: [],
                notifications: [],
                chats: [],
                resources: [],
                activeChat: null,
                currentTab: 'dashboard'
            },

            async init() {
                this.init3D();
                const savedTheme = localStorage.getItem('theme') || 'light';
                document.body.setAttribute('data-theme', savedTheme);
                this.updateThemeToggle(savedTheme);

                setInterval(() => {
                    const el = document.getElementById('live-clock');
                    if (el) el.innerText = new Date().toLocaleTimeString('en-US', { hour12: true, hour: '2-digit', minute: '2-digit', second: '2-digit' });
                }, 1000);

                await signInAnonymously(auth);
                setTimeout(() => { document.getElementById('loader').classList.add('hidden'); }, 1000);

                document.getElementById('login-form').onsubmit = (e) => this.handleLogin(e);
                document.getElementById('chat-form').onsubmit = (e) => this.sendChat(e);
                window.App = this;
            },

            toggleTheme() {
                const currentTheme = document.body.getAttribute('data-theme');
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                document.body.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                this.updateThemeToggle(newTheme);
            },

            updateThemeToggle(theme) {
                const sunIcon = document.querySelector('.theme-toggle .fa-sun');
                const moonIcon = document.querySelector('.theme-toggle .fa-moon');
                if (theme === 'light') { sunIcon.style.opacity = '1'; moonIcon.style.opacity = '0.5'; }
                else { sunIcon.style.opacity = '0.5'; moonIcon.style.opacity = '1'; }
            },

            async handleLogin(e) {
                e.preventDefault();
                const u = document.getElementById('l-user').value.trim();
                const p = document.getElementById('l-pass').value;
                const btn = e.target.querySelector('button');
                btn.innerText = 'SYNCING NODE...';

                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'mentors'), snap => {
                    const match = snap.docs.find(d => (d.data().email === u || d.data().name === u) && d.data().spec === p);
                    if (match) {
                        this.state.user = { id: match.id, ...match.data() };
                        this.enterPortal();
                    } else {
                        document.getElementById('login-error').classList.remove('hidden');
                        btn.innerText = 'AUTHORIZE HUB';
                    }
                }, { once: true });
            },

            enterPortal() {
                document.getElementById('view-login').classList.add('hidden');
                document.getElementById('view-portal').classList.remove('hidden');
                document.getElementById('u-name').innerText = this.state.user.name;
                document.getElementById('u-avatar').innerText = this.state.user.name[0];
                this.sync();
            },

            sync() {
                const targets = ['students', 'projects', 'tasks', 'notifications', 'chats', 'resources'];
                targets.forEach(col => {
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', col), snap => {
                        this.state[col] = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        this.render();
                    });
                });
            },

            switchTab(t) {
                this.state.currentTab = t;
                document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
                const tabEl = document.getElementById(`tab-${t}`);
                const navEl = document.getElementById(`nav-${t}`);
                if (tabEl) tabEl.classList.remove('hidden');
                if (navEl) navEl.classList.add('active');
                document.getElementById('view-title').innerText = t.charAt(0).toUpperCase() + t.slice(1).replace('-', ' ');
                this.render();
            },

            render() {
                const { user, students, projects, tasks, notifications, resources, currentTab } = this.state;
                if (!user) return;

                // Ensure unique students based on SRN to fix duplication
                const myStudentsMap = new Map();
                students.filter(s => s.mentor === user.email).forEach(s => {
                    if (!myStudentsMap.has(s.srn)) myStudentsMap.set(s.srn, s);
                });
                const myStudents = Array.from(myStudentsMap.values());

                const myProjects = projects.filter(p => p.mentor === user.email);
                const myTasks = tasks.filter(t => myStudents.some(s => s.id === t.sid || s.srn === t.sid));

                document.getElementById('stat-students').innerText = myStudents.length;
                document.getElementById('stat-teams').innerText = myProjects.length;
                document.getElementById('stat-pending').innerText = myProjects.reduce((sum, p) => sum + (p.points?.filter(pt => pt.status === 'pending').length || 0), 0);
                document.getElementById('stat-feed').innerText = notifications.length;

                if (currentTab === 'dashboard') {
                    ui.html('dash-roster', myStudents.slice(0, 5).map(s => `<div style="padding:15px; background:var(--surface); border-radius:20px; border:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;"><span style="font-weight:700;">${s.name}</span><span class="badge ${s.att === 'verified' ? 'bg-e' : 'bg-a'}">${s.att || 'offline'}</span></div>`).join(''));

                    const pendingItems = [];
                    myProjects.forEach(p => {
                        (p.points || []).forEach((pt, idx) => {
                            if (pt.status === 'pending') pendingItems.push({ project: p, pointIndex: idx });
                        });
                    });
                    ui.html('dash-pending', pendingItems.slice(0, 5).map(item => `<div style="padding:15px; background:var(--surface); border-radius:20px; border:1px solid var(--border);"><div style="display:flex; justify-content:space-between;"><span class="badge bg-warning">PENDING</span><small>${item.project.teamName}</small></div><p style="font-size:12px; margin-top:8px;">Point ${item.pointIndex + 1} approval requested</p><button onclick="App.approvePoint('${item.project.id}', ${item.pointIndex})" class="btn-p btn-sm" style="width:100%; margin-top:10px;">VERIFY</button></div>`).join('') || '<p class="info-label">Queue clear.</p>');
                }

                if (currentTab === 'teambuilder') {
                    ui.html('teams-container', myProjects.map(p => {
                        const approved = p.points?.filter(pt => pt.status === 'approved').length || 0;
                        const total = p.totalPoints || p.points?.length || 0;
                        const teamAssets = p.teamResources || [];

                        return `<div class="card">
                            <div style="display:flex; justify-content:space-between; align-items:start;">
                                <h4 style="font-weight:800; font-size:1.3rem;">${p.teamName}</h4>
                                <button onclick="App.deleteItem('projects','${p.id}')" style="color:var(--danger); background:none; border:none; cursor:pointer; font-size:1rem;"><i class="fas fa-trash-can"></i></button>
                            </div>
                            <p class="info-label" style="margin-top:10px;">Objective: ${p.name}</p>
                            
                            <div class="progress-track"><div class="progress-fill" style="width: ${(approved / total * 100) || 0}%"></div></div>
                            <div class="points-grid">${p.points?.map((pt, i) => pt.status === 'pending' ? `<div class="point-node pending" title="Verify Node" onclick="App.approvePoint('${p.id}', ${i})">${i + 1}</div>` : `<div class="point-node ${pt.status}">${i + 1}</div>`).join('')}</div>
                            
                            <div style="margin-top:10px; margin-bottom:15px; display:flex; flex-wrap:wrap; gap:6px;">
                                ${p.members?.map(m => `<span class="badge bg-p" style="font-size:9px;">${m}</span>`).join('') || 'No members'}
                            </div>

                            <div style="margin-top:10px; padding:15px; background:rgba(99,102,241,0.05); border-radius:24px; border:1.5px dashed var(--primary);">
                                <span class="info-label">Primary Project Protocol (PDF)</span>
                                ${p.pdfUrl ? `
                                    <div class="asset-item" style="background:var(--surface);">
                                        <a href="${p.pdfUrl}" target="_blank"><i class="fas fa-file-contract"></i> ${p.pdfFileName || 'Primary Spec'}</a>
                                    </div>
                                ` : '<p style="font-size:11px; opacity:0.6;">No protocol uploaded.</p>'}
                                <input type="file" id="main-pdf-${p.id}" accept=".pdf" style="font-size:10px; margin-top:10px;">
                                <button onclick="App.updateMainProtocol('${p.id}')" class="btn-p btn-sm" style="width:100%; margin-top:8px; height:45px;">INITIALIZE INFO PDF</button>
                            </div>

                            <div style="margin-top:20px;">
                                <span class="info-label">Project Technical Resources (${teamAssets.length})</span>
                                <div id="asset-list-${p.id}">
                                    ${teamAssets.map((asset, index) => `
                                        <div class="asset-item">
                                            <a href="${asset.pdfUrl}" target="_blank"><i class="fas fa-file-pdf"></i> ${asset.title}</a>
                                            <button onclick="App.removeTeamResource('${p.id}', ${index})" class="del-btn"><i class="fas fa-times"></i></button>
                                        </div>
                                    `).join('') || '<p style="font-size:11px; opacity:0.5; text-align:center; padding:10px;">Asset Repository Empty.</p>'}
                                </div>
                            </div>

                            <div style="margin-top:auto; border-top:1px solid var(--border); padding-top:20px;">
                                <span class="info-label">Matrix Configuration</span>
                                <div style="display:grid; grid-template-columns: 80px 1fr; gap:10px;">
                                    <input type="number" id="score-${p.id}" value="${total}" title="Grid Complexity">
                                    <button onclick="App.updateClusterMap('${p.id}')" class="btn-p btn-sm" style="height:48px;">SYNC MATRIX</button>
                                </div>
                                <div style="margin-top:10px; padding:15px; background:var(--bg); border-radius:24px;">
                                    <input type="text" id="asset-title-${p.id}" placeholder="Asset Name (e.g. Phase 1 Schematics)" style="margin-top:0;">
                                    <input type="file" id="asset-file-${p.id}" accept=".pdf" style="font-size:10px; margin-top:5px;">
                                    <button onclick="App.addTeamResource('${p.id}')" class="btn-p btn-sm" style="width:100%; margin-top:12px; background:var(--primary); color:white;">DEPLOY SUPPLEMENTARY ASSET</button>
                                </div>
                            </div>
                        </div>`;
                    }).join(''));
                }

                if (currentTab === 'my-students') {
                    ui.html('my-students-grid', myStudents.map(s => {
                        const studentProjects = projects.filter(p => p.members?.includes(s.name));
                        return `
                            <div class="student-pro-card">
                                <div class="student-info-row">
                                    <div class="student-initials">${s.name[0]}</div>
                                    <div style="flex:1; overflow:hidden;">
                                        <h4 style="font-weight:800; font-size:1.15rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${s.name}</h4>
                                        <span style="font-size:11px; font-weight:700; opacity:0.6;">${s.srn}</span>
                                    </div>
                                    <div class="badge ${s.att === 'verified' ? 'bg-e' : 'bg-a'}">${s.att || 'offline'}</div>
                                </div>
                                
                                <p class="info-label">Technical Profile</p>
                                <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:15px;">
                                    <span class="badge bg-p" style="border:2px solid var(--primary);">${s.branch || 'EC/CS'}</span>
                                    <span class="badge bg-p" style="border:2px solid var(--primary);">Semester ${s.semester || '5'}</span>
                                </div>

                                <div class="student-meta">
                                    <div class="meta-box">
                                        <span class="meta-val">${studentProjects.length}</span>
                                        <span class="meta-lab">Tracks</span>
                                    </div>
                                    <div class="meta-box">
                                        <span class="meta-val">${s.attendanceCount || 0}</span>
                                        <span class="meta-lab">Logs</span>
                                    </div>
                                </div>

                                <div style="margin-top:25px; display:flex; gap:12px;">
                                    <button onclick="App.openChat('${s.id}', '${s.name}')" class="btn-p btn-sm" style="flex:1.2; padding:14px; font-size:11px; border-radius:18px;">
                                        <i class="fas fa-message"></i> SYNC NODE
                                    </button>
                                    <button onclick="App.viewStudentAssets('${s.id}')" class="btn-p btn-sm" style="flex:1; padding:14px; font-size:11px; border-radius:18px; background:var(--bg); color:var(--primary); border:2.5px solid var(--border);">
                                        <i class="fas fa-folder-open"></i> ASSETS
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('') || '<p class="info-label" style="text-align:center; padding:50px;">No students mapped.</p>');
                }

                if (currentTab === 'resources') {
                    ui.html('resources-table-body', resources.map(r => `<tr>
                        <td><b style="font-weight:700;">${r.title}</b></td>
                        <td><span class="badge bg-p">${r.category}</span></td>
                        <td>${r.uploadedBy || 'Academic Node'}</td>
                        <td><button onclick="App.deleteItem('resources', '${r.id}')" class="mark-btn btn-no"><i class="fas fa-trash-can"></i></button></td>
                    </tr>`).join('') || '<tr><td colspan="4" style="text-align:center; padding:30px; opacity:0.6;">Library Repository Offline.</td></tr>');
                }

                if (currentTab === 'attendance') {
                    ui.html('att-table-body', myStudents.map(s => `<tr><td><b style="font-weight:800;">${s.srn}</b></td><td>${s.name}</td><td>${s.time || '--'}</td><td><span class="badge ${s.att === 'verified' ? 'bg-e' : 'bg-a'}">${s.att || 'offline'}</span></td><td><div style="display:flex; gap:8px;"><button onclick="App.setAtt('${s.id}','verified')" class="mark-btn btn-yes"><i class="fas fa-check"></i></button> <button onclick="App.setAtt('${s.id}','absent')" class="mark-btn btn-no"><i class="fas fa-times"></i></button></div></td></tr>`).join(''));
                }
            },

            async updateMainProtocol(projId) {
                const fileIn = document.getElementById(`main-pdf-${projId}`);
                if (!fileIn.files[0]) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'projects', projId), {
                            pdfUrl: e.target.result,
                            pdfFileName: fileIn.files[0].name
                        });
                        alert("Primary Protocol PDF Synchronized.");
                    } catch (err) {
                        console.error(err);
                        alert("Upload Error: File size likely exceeds Firestore document limits (1MB). Please use a smaller PDF.");
                    }
                };
                reader.readAsDataURL(fileIn.files[0]);
            },

            async addTeamResource(projId) {
                const fileIn = document.getElementById(`asset-file-${projId}`);
                const titleIn = document.getElementById(`asset-title-${projId}`);
                const proj = this.state.projects.find(p => p.id === projId);
                if (!fileIn.files[0] || !titleIn.value) { alert("Deployment Error: Asset Name & Payload PDF Required."); return; }
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const newAsset = { title: titleIn.value, pdfUrl: e.target.result, uploadedAt: new Date().toISOString() };
                        const teamResources = [...(proj.teamResources || []), newAsset];
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'projects', projId), { teamResources });
                        fileIn.value = ''; titleIn.value = ''; alert("Technical Resource Dispatched.");
                    } catch (err) {
                        alert("Sync Error: The PDF payload is too large for this data node.");
                    }
                };
                reader.readAsDataURL(fileIn.files[0]);
            },

            async removeTeamResource(projId, index) {
                if (!confirm("Purge technical asset?")) return;
                const proj = this.state.projects.find(p => p.id === projId);
                const teamResources = [...(proj.teamResources || [])];
                teamResources.splice(index, 1);
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'projects', projId), { teamResources });
            },

            async updateClusterMap(projId) {
                const newTotal = parseInt(document.getElementById(`score-${projId}`).value);
                const proj = this.state.projects.find(p => p.id === projId);
                let newPoints = [...(proj.points || [])];
                if (newTotal > newPoints.length) for (let i = newPoints.length; i < newTotal; i++) newPoints.push({ status: 'none' });
                else if (newTotal < newPoints.length) newPoints = newPoints.slice(0, newTotal);
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'projects', projId), { points: newPoints, totalPoints: newTotal });
                alert("Cluster Matrix Re-calibrated.");
            },

            async addResource() {
                const title = document.getElementById('r-title').value;
                const category = document.getElementById('r-cat').value;
                const fileIn = document.getElementById('r-file');
                if (!title || !fileIn.files[0]) { alert("Library Deployment: Identity & Payload Required."); return; }

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'resources'), {
                            title, category, pdfUrl: e.target.result,
                            uploadedBy: this.state.user.name, date: new Date().toISOString()
                        });
                        alert("Global Library Synchronized.");
                        this.closeModal();
                    } catch (err) {
                        alert("Transmission Error: Node memory limit reached. Try a smaller file.");
                    }
                };
                reader.readAsDataURL(fileIn.files[0]);
            },

            async approvePoint(pid, idx) {
                const proj = this.state.projects.find(p => p.id === pid);
                const points = [...proj.points];
                points[idx] = { status: 'approved' };
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'projects', pid), { points });
            },

            async setAtt(id, val) {
                const student = this.state.students.find(s => s.id === id);
                const currentCount = student?.attendanceCount || 0;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', id), {
                    att: val,
                    time: new Date().toLocaleTimeString('en-US', { hour12: true, hour: '2-digit', minute: '2-digit' }),
                    attendanceCount: val === 'verified' ? currentCount + 1 : currentCount
                });
            },

            async deleteItem(col, id) { if (confirm("Permanently purge record from technical ledger?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', col, id)); },

            showModal(type) {
                const bg = document.getElementById('modal-bg');
                const content = document.getElementById('modal-content');
                bg.classList.add('active');
                if (type === 'resource') {
                    content.innerHTML = `<h3>Deploy Hub Resource</h3>
                        <label class="info-label">Resource Identity</label><input type="text" id="r-title" placeholder="e.g. Unit-5 Roadmap">
                        <label class="info-label">Classification</label><select id="r-cat"><option value="syllabus">Syllabus</option><option value="notes">Lecture Notes</option><option value="reference">Reference Material</option><option value="pastpapers">Past Papers</option></select>
                        <label class="info-label">PDF Payload</label><input type="file" id="r-file" accept=".pdf">
                        <button onclick="App.addResource()" class="btn-p" style="width:100%; margin-top:20px; height:55px;">SYNC TO HUB</button>`;
                } else if (type === 'project') {
                    // Logic to ensure unique student names for checkboxes based on SRN
                    const uniqueStudentsMap = new Map();
                    this.state.students.filter(s => s.mentor === this.state.user.email).forEach(s => {
                        if (!uniqueStudentsMap.has(s.srn)) uniqueStudentsMap.set(s.srn, s);
                    });
                    const mentorStudents = Array.from(uniqueStudentsMap.values());

                    content.innerHTML = `
                        <h3 style="margin-bottom:10px;">Initialize Node Cluster</h3>
                        <p style="font-size:12px; opacity:0.7; margin-bottom:25px;">Define technical track parameters and assign node members (Unique nodes only).</p>
                        
                        <label class="info-label">Research Track Domain</label>
                        <select id="m-p-track"><option>Track Alpha (Electronics)</option><option>Track Beta (Cloud/CS)</option><option>Track Gamma (Research Core)</option></select>
                        
                        <label class="info-label">Cluster Identity (e.g. NEO_AI_01)</label>
                        <input type="text" id="m-p-team" placeholder="Unique Cluster Name">
                        
                        <label class="info-label">Core Roadmap Objective</label>
                        <input type="text" id="m-p-name" placeholder="Research Project Title">
                        
                        <label class="info-label">Initial Matrix Points (Grid Complexity)</label>
                        <input type="number" id="m-p-total-points" value="24" min="1" max="200">
                        
                        <label class="info-label">Assign Exclusive Node Members</label>
                        <div class="check-list">
                            ${mentorStudents.map((s, i) => `
                                <div class="check-item">
                                    <input type="checkbox" id="node-${i}" value="${s.name}" class="student-checkbox">
                                    <label for="node-${i}">${s.name} (${s.srn})</label>
                                </div>
                            `).join('') || '<p style="font-size:11px; padding:20px;">No nodes assigned to your command.</p>'}
                        </div>
                        
                        <button onclick="App.addProject()" class="btn-p" style="width:100%; margin-top:10px; height:55px; justify-content:center;">DEPLOY NODE CLUSTER</button>`;
                } else if (type === 'task') {
                    content.innerHTML = `<h3>Dispatch Directive</h3>
                        <label class="info-label">Target Node</label><select id="m-t-sid">${this.state.students.filter(s => s.mentor === this.state.user.email).map(s => `<option value="${s.id}">${s.name}</option>`).join('')}</select>
                        <label class="info-label">Instruction Payload</label><textarea id="m-t-desc" placeholder="Detail directive parameters..." style="height:100px;"></textarea>
                        <label class="info-label">Deadline Time</label><input type="text" id="m-t-due" placeholder="e.g. 15:00 Monday">
                        <button onclick="App.addTask()" class="btn-p" style="width:100%; margin-top:20px; height:55px;">TRANSMIT</button>`;
                }
            },

            async addProject() {
                const track = document.getElementById('m-p-track').value;
                const teamName = document.getElementById('m-p-team').value;
                const name = document.getElementById('m-p-name').value;
                const totalPoints = parseInt(document.getElementById('m-p-total-points').value) || 24;
                const members = Array.from(document.querySelectorAll('.student-checkbox:checked')).map(c => c.value);

                if (!teamName || !name || members.length === 0) { alert("Initialization Failure: Parameters Incomplete."); return; }

                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'projects'), {
                    track, teamName, name, mentor: this.state.user.email,
                    members, points: Array(totalPoints).fill({ status: 'none' }),
                    totalPoints, teamResources: [], pdfUrl: '', pdfFileName: ''
                });
                this.closeModal();
            },

            async addTask() {
                const sid = document.getElementById('m-t-sid').value;
                const desc = document.getElementById('m-t-desc').value;
                const due = document.getElementById('m-t-due').value;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'tasks'), { sid, desc, due, status: 'Pending' });
                this.closeModal();
            },

            async sendBroadcast() {
                const text = document.getElementById('b-text').value;
                if (!text) return;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'notifications'), { from: this.state.user.name, senderRole: 'Mentor', text, time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) });
                document.getElementById('b-text').value = '';
                alert("Technical Transmission Sent.");
            },

            closeModal() { document.getElementById('modal-bg').classList.remove('active'); },
            openChat(id, name) { this.state.activeChat = id; this.renderSyncWindow(); this.switchTab('sync'); },
            renderSyncWindow() { document.getElementById('chat-window').innerHTML = '<p class="info-label" style="text-align:center;">Secure P2P Sync Hub Established.</p>'; },
            async sendChat(e) { e.preventDefault(); document.getElementById('chat-input').value = ''; },
            viewStudentAssets(id) { document.getElementById('asset-student-picker').value = id; this.exploreAssets(); this.switchTab('assethub'); },
            exploreAssets() {
                const sid = document.getElementById('asset-student-picker').value;
                if (!sid) return;
                const student = this.state.students.find(s => s.id === sid);
                const taskLinks = this.state.tasks.filter(t => (t.sid === sid || t.sid === student?.srn) && t.payload);
                const projLinks = this.state.projects.filter(p => p.members?.includes(student?.name) && p.driveLink);
                let html = '';
                if (projLinks.length) html += `<div class="card" style="grid-column: span 2;"><span class="info-label">Project Technical Submissions</span>${projLinks.map(p => `<div class="asset-item"><a href="${p.driveLink}" target="_blank">${p.teamName}: Anchor Link</a></div>`).join('')}</div>`;
                if (taskLinks.length) html += `<div class="card" style="grid-column: span 2;"><span class="info-label">Directive Payload Links</span>${taskLinks.map(t => `<div class="asset-item"><a href="${t.payload}" target="_blank">${t.desc.slice(0, 40)}...</a></div>`).join('')}</div>`;
                ui.html('asset-list-container', html || '<p class="info-label" style="text-align:center; grid-column:span 2; padding:40px;">No technical assets synchronized for this node.</p>');
                document.getElementById('asset-results').classList.remove('hidden');
            },

            init3D() {
                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                document.getElementById('canvas-container').appendChild(renderer.domElement);
                const bubbles = [];
                for (let i = 0; i < 40; i++) {
                    const b = new THREE.Mesh(new THREE.SphereGeometry(0.8, 32, 32), new THREE.MeshPhongMaterial({ color: 0x6366F1, transparent: true, opacity: 0.08 }));
                    b.position.set((Math.random() - 0.5) * 200, (Math.random() - 0.5) * 200, (Math.random() - 0.5) * 200);
                    b.userData.v = new THREE.Vector3((Math.random() - 0.5) * 0.02, (Math.random() - 0.5) * 0.02, (Math.random() - 0.5) * 0.02);
                    scene.add(b); bubbles.push(b);
                }
                scene.add(new THREE.AmbientLight(0xffffff, 0.9));
                camera.position.z = 100;
                const animate = () => {
                    requestAnimationFrame(animate);
                    bubbles.forEach(b => {
                        b.position.add(b.userData.v);
                        if (Math.abs(b.position.x) > 100) b.userData.v.x *= -1;
                        if (Math.abs(b.position.y) > 100) b.userData.v.y *= -1;
                        if (Math.abs(b.position.z) > 100) b.userData.v.z *= -1;
                    });
                    renderer.render(scene, camera);
                };
                animate();
            }
        };

        window.App = App;
        window.onload = () => App.init();
    </script>
</body>

</html>
