<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMPS Tech | Mentor Command Hub</title>
    <!-- Premium Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- 3D Engine -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #4F46E5;
            --primary-glow: rgba(79, 70, 229, 0.3);
            --dark: #0F172A;
            --slate: #475569;
            --bg: #FFFFFF;
            --border: rgba(203, 213, 225, 0.5);
            --radius-lg: 20px;
            --radius-xl: 36px;
            --emerald: #10B981;
            --amber: #F59E0B;
            --rose: #F43F5E;
            --panel-bg: #F8FAFC;
            --glass-bg: rgba(255, 255, 255, 0.85);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            outline: none;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f8fafc;
            color: var(--dark);
            overflow: hidden;
            height: 100vh;
        }

        #canvas-container {
            position: fixed;
            inset: 0;
            z-index: -1;
            background: radial-gradient(circle at 20% 30%, #ffffff 0%, #f1f4fb 70%, #e8edf7 100%);
        }

        /* ----- LOGIN VIEW ----- */
        #view-login {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at top right, #1e293b, #0f172a);
            z-index: 5000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .login-card {
            background: #fff;
            padding: 50px;
            border-radius: 40px;
            width: 100%;
            max-width: 440px;
            text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        /* ----- CORE LAYOUT ----- */
        #view-portal {
            display: flex;
            height: 100vh;
            margin-top: 40px;
            height: calc(100vh - 40px);
            position: relative;
            z-index: 100;
            overflow: hidden;
        }

        .sidebar {
            width: 280px;
            padding: 30px 20px;
            background: var(--glass-bg);
            backdrop-filter: blur(30px);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            height: 100%;
        }

        .sidebar-link {
            padding: 14px 20px;
            border-radius: 16px;
            color: var(--slate);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: 0.2s;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .sidebar-link:hover {
            background: rgba(79, 70, 229, 0.08);
            color: var(--primary);
        }

        .sidebar-link.active {
            background: var(--primary);
            color: #fff;
            box-shadow: 0 10px 25px -5px var(--primary-glow);
        }

        .nav-label {
            font-size: 10px;
            font-weight: 800;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin: 25px 0 10px 15px;
        }

        .workspace {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.2);
        }

        /* ----- COMPONENTS ----- */
        .bento-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 24px;
            margin-bottom: 30px;
        }

        .card {
            padding: 25px;
            border-radius: var(--radius-lg);
            background: #fff;
            border: 1px solid var(--border);
            transition: var(--transition);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.01);
        }

        .card:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.04);
        }

        .info-label {
            font-size: 9px;
            font-weight: 800;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 10px;
            display: block;
        }

        .info-value {
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--dark);
        }

        .table-wrap {
            background: #fff;
            border-radius: 20px;
            border: 1px solid var(--border);
            overflow: hidden;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 18px 20px;
            font-size: 10px;
            font-weight: 900;
            color: #94a3b8;
            text-transform: uppercase;
            border-bottom: 1.5px solid #f1f5f9;
            background: #fafafa;
        }

        td {
            padding: 18px 20px;
            font-size: 13px;
            font-weight: 600;
            border-bottom: 1px solid #f1f5f9;
        }

        .btn-p {
            background: var(--primary);
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 800;
            font-size: 11px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-p:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px var(--primary-glow);
        }

        .mark-btn {
            width: 34px;
            height: 34px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            color: #fff;
            transition: 0.2s;
            font-size: 14px;
        }

        .btn-yes {
            background: var(--emerald);
        }

        .btn-no {
            background: var(--rose);
        }

        /* ----- ASSET HUB ----- */
        .asset-item {
            padding: 18px;
            background: #fff;
            border-radius: 20px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: 0.2s;
        }

        .asset-item:hover {
            border-color: var(--primary);
            transform: translateX(5px);
        }

        .asset-item a {
            font-size: 12px;
            font-weight: 700;
            color: var(--primary);
            text-decoration: none;
            word-break: break-all;
        }

        .asset-meta {
            font-size: 10px;
            font-weight: 800;
            color: var(--slate);
            text-transform: uppercase;
            display: flex;
            justify-content: space-between;
        }

        /* ----- CHECKBOX LIST ----- */
        .check-list {
            max-height: 200px;
            overflow-y: auto;
            background: #F8FAFC;
            border: 1.5px solid var(--border);
            border-radius: 15px;
            padding: 10px;
            margin-top: 10px;
        }

        .check-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
        }

        .check-item:last-child {
            border-bottom: none;
        }

        .check-item input {
            width: 18px;
            height: 18px;
            cursor: pointer;
            margin: 0;
        }

        .check-item label {
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            flex: 1;
        }

        /* ----- MODAL ----- */
        .modal-bg {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.75);
            backdrop-filter: blur(8px);
            z-index: 6000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-bg.active {
            display: flex;
        }

        .modal-card {
            background: #fff;
            width: 100%;
            max-width: 600px;
            border-radius: 40px;
            padding: 40px;
            max-height: 85vh;
            overflow-y: auto;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 15px;
            border-radius: 15px;
            border: 1.5px solid var(--border);
            font-weight: 600;
            outline: none;
            background: #F8FAFC;
            margin-top: 8px;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 9px;
            font-weight: 800;
            text-transform: uppercase;
        }

        .bg-e {
            background: #d1fae5;
            color: #10b981;
        }

        .bg-a {
            background: #fef3c7;
            color: #f59e0b;
        }

        .bg-p {
            background: #eef2ff;
            color: #4f46e5;
        }

        .ticker-wrap {
            position: fixed;
            top: 0;
            width: 100%;
            height: 40px;
            background: var(--dark);
            color: #fff;
            z-index: 1100;
            display: flex;
            align-items: center;
            overflow: hidden;
            font-size: 10px;
            font-weight: 800;
            letter-spacing: 1.5px;
        }

        .ticker-move {
            display: flex;
            white-space: nowrap;
            animation: ticker-scroll 60s linear infinite;
            gap: 6rem;
        }

        @keyframes ticker-scroll {
            0% {
                transform: translateX(100%);
            }

            100% {
                transform: translateX(-100%);
            }
        }

        .hidden {
            display: none !important;
        }

        #loader {
            position: fixed;
            inset: 0;
            background: #fff;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f1f5f9;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <div id="canvas-container"></div>
    <div id="loader">
        <div class="spinner"></div>
    </div>

    <div id="ticker-bar" class="ticker-wrap">
        <div class="ticker-move">
            <span><i class="fas fa-shield"></i> SYSTEM STATUS: COMMAND HUB V6.1 DEPLOYED.</span>
            <span><i class="fas fa-bolt"></i> FACULTY UPDATE: CUMULATIVE POINT ENGINE (100) NOW OPERATIONAL.</span>
            <span><i class="fas fa-sync"></i> PROTOCOL: UPLOAD REFERENCE PDFS IN TEAM BUILDER FOR NODE SYNC.</span>
        </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="view-login">
        <div class="login-card">
            <i class="fas fa-shield-halved" style="font-size: 4rem; color: var(--primary); margin-bottom: 25px;"></i>
            <h2 style="font-weight: 900; letter-spacing: -1.5px; font-size: 2.2rem;">Command Node</h2>
            <p style="font-size: 13px; color: var(--slate); margin-bottom: 35px; font-weight: 600;">Authorized Mentor
                Identification Required</p>
            <form id="login-form">
                <input type="text" id="l-user" placeholder="Mentor Username / Email" required
                    style="border-radius:40px; padding:18px 25px; margin-bottom:15px;">
                <input type="password" id="l-pass" placeholder="Authorization Token" required
                    style="border-radius:40px; padding:18px 25px; margin-bottom:30px;">
                <button type="submit" class="btn-p"
                    style="width:100%; height:60px; justify-content:center; border-radius:50px; font-size:12px;">Launch
                    HUB</button>
            </form>
            <p id="login-error" style="color: var(--rose); font-size: 11px; margin-top: 20px; font-weight: 800;"
                class="hidden"><i class="fas fa-circle-exclamation"></i> ACCESS_DENIED: NODE MISMATCH</p>
        </div>
    </div>

    <!-- MAIN PORTAL -->
    <div id="view-portal" class="hidden">
        <aside class="sidebar">
            <div class="logo"><i class="fas fa-shield-halved"></i><span>SMPS <b>Command</b></span></div>

            <nav style="flex: 1;">
                <div class="nav-label">Executive</div>
                <div onclick="App.switchTab('dashboard')" id="nav-dashboard" class="sidebar-link active"><i
                        class="fas fa-grid-2"></i> Station Home</div>
                <div onclick="App.switchTab('attendance')" id="nav-attendance" class="sidebar-link"><i
                        class="fas fa-calendar-check"></i> Attendance</div>
                <div onclick="App.switchTab('teambuilder')" id="nav-teambuilder" class="sidebar-link"><i
                        class="fas fa-users-gear"></i> Team Builder</div>

                <div class="nav-label">Asset Command</div>
                <div onclick="App.switchTab('assethub')" id="nav-assethub" class="sidebar-link"><i
                        class="fas fa-magnifying-glass"></i> Node Assets</div>
                <div onclick="App.switchTab('tasks')" id="nav-tasks" class="sidebar-link"><i
                        class="fas fa-list-check"></i> Directives</div>
                <div onclick="App.switchTab('sync')" id="nav-sync" class="sidebar-link"><i class="fas fa-message"></i>
                    Sync Hub</div>
                <div onclick="App.switchTab('broadcast')" id="nav-broadcast" class="sidebar-link"><i
                        class="fas fa-bullhorn"></i> Transmissions</div>
            </nav>

            <div
                style="margin-top: auto; padding: 20px; background: rgba(255,255,255,0.06); border-radius: 24px; border: 1px solid var(--border);">
                <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 15px;">
                    <div id="u-avatar" class="avatar-circle"
                        style="width:40px; height:40px; font-size:1.1rem; border-radius:12px;">M</div>
                    <div style="overflow:hidden;">
                        <p id="u-name"
                            style="font-size: 12px; font-weight: 800; color:var(--dark); white-space: nowrap; text-overflow: ellipsis;">
                            Mentor</p>
                        <span class="badge bg-e" style="font-size: 7px; padding: 2px 6px;">DATA SYNC ACTIVE</span>
                    </div>
                </div>
                <button onclick="location.reload()"
                    style="width:100%; background:none; border:1px solid #fee2e2; padding:10px; border-radius:12px; font-size:10px; font-weight:800; cursor:pointer; color:var(--rose);">TERMINATE
                    SESSION</button>
            </div>
        </aside>

        <main class="workspace">
            <header style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 40px;">
                <div>
                    <h2 id="view-title" style="font-size: 2.6rem; font-weight: 900; letter-spacing: -2.5px;">Command
                        Station</h2>
                    <p id="live-clock"
                        style="font-size: 1.1rem; font-weight: 700; color: var(--primary); margin-top: 5px;">00:00:00 AM
                    </p>
                </div>
                <div style="text-align: right;">
                    <span class="badge bg-p" style="padding:8px 16px; border-radius:40px;">CORE_NODE_V6.1</span>
                </div>
            </header>

            <!-- DASHBOARD -->
            <div id="tab-dashboard">
                <div class="bento-grid">
                    <div class="card"><span class="info-label">Assigned Nodes</span>
                        <div class="info-value" id="stat-students">0</div>
                    </div>
                    <div class="card"><span class="info-label">Active Clusters</span>
                        <div class="info-value" id="stat-teams">0</div>
                    </div>
                    <div class="card"><span class="info-label">Verification Queue</span>
                        <div class="info-value" id="stat-pending" style="color:var(--amber);">0</div>
                    </div>
                    <div class="card"><span class="info-label">Global Directives</span>
                        <div class="info-value" id="stat-feed">0</div>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:28px;">
                    <div class="card">
                        <h4 style="font-weight:900; font-size:1rem; margin-bottom:20px; letter-spacing:-0.5px;">Student
                            Ledger Pulse</h4>
                        <div id="dash-roster" style="display:flex; flex-direction:column; gap:12px;"></div>
                    </div>
                    <div class="card">
                        <h4 style="font-weight:900; font-size:1rem; margin-bottom:20px; letter-spacing:-0.5px;">
                            Broadcast Activity</h4>
                        <div id="dash-notifs" style="display:flex; flex-direction:column; gap:12px;"></div>
                    </div>
                </div>
            </div>

            <!-- ATTENDANCE -->
            <div id="tab-attendance" class="hidden">
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>SRN</th>
                                <th>Node Identity</th>
                                <th>Portal Sync</th>
                                <th>Status</th>
                                <th>Verification</th>
                            </tr>
                        </thead>
                        <tbody id="att-table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- TEAM BUILDER (Separate Section for Groups) -->
            <div id="tab-teambuilder" class="hidden">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
                    <h3 style="font-weight:900; letter-spacing:-1.2px;">Dual-Track Cluster Control</h3>
                    <button class="btn-p" onclick="App.showModal('project')"><i class="fas fa-plus"></i> Initialize
                        Cluster</button>
                </div>
                <div id="teams-container" style="display:grid; grid-template-columns: 1fr 1fr; gap:28px;"></div>
            </div>

            <!-- ASSET HUB (Separate Section for viewing all links) -->
            <div id="tab-assethub" class="hidden">
                <div class="card" style="margin-bottom: 25px; border-left: 8px solid var(--primary);">
                    <span class="info-label">Technical Submission Explorer</span>
                    <p style="font-size:12px; color:var(--slate); margin-bottom:15px;">Select a student node to
                        aggregate all historical research anchors and directive payloads.</p>
                    <div style="display:flex; gap:15px; margin-top:10px;">
                        <select id="asset-student-picker"
                            style="flex:1; border-radius:40px; padding-left:25px;"></select>
                        <button onclick="App.exploreAssets()" class="btn-p"
                            style="border-radius:40px; padding:0 35px;">EXPLORE</button>
                    </div>
                </div>
                <div id="asset-results" class="hidden" style="margin-top:40px;">
                    <h3 id="asset-title" class="info-value"
                        style="font-size:1.6rem; margin-bottom:25px; letter-spacing:-1px;">Node Assets</h3>
                    <div id="asset-list-container" style="display:grid; grid-template-columns: 1fr 1fr; gap:24px;">
                    </div>
                </div>
            </div>

            <!-- DIRECTIVES (TASKS) -->
            <div id="tab-tasks" class="hidden">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
                    <h3 style="font-weight:900; letter-spacing:-1px;">Instruction Payload Dispatch</h3>
                    <button class="btn-p" onclick="App.showModal('task')"><i class="fas fa-bolt"></i> Dispatch
                        Directive</button>
                </div>
                <div id="tasks-grid"
                    style="display:grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap:24px;"></div>
            </div>

            <!-- SYNC HUB (CHAT) -->
            <div id="tab-sync" class="hidden">
                <div class="chat-hub">
                    <aside class="chat-list" id="chat-roster"></aside>
                    <main class="chat-main">
                        <div id="chat-h"
                            style="padding: 20px 30px; border-bottom: 1px solid var(--border); font-weight: 800; color: var(--primary); font-size:1rem; display:flex; justify-content:space-between; align-items:center;">
                            <span id="chat-title-node">Support Sync Hub</span>
                            <span class="badge bg-e" style="font-size:8px;">P2P_STABLE</span>
                        </div>
                        <div id="chat-window" class="chat-msgs"></div>
                        <form id="chat-form"
                            style="padding: 20px 30px; border-top: 1px solid var(--border); display: flex; gap: 15px;">
                            <input type="text" id="chat-input" placeholder="Transmit packet..." required
                                style="flex:1; border-radius:40px; padding:15px 25px;">
                            <button type="submit" class="btn-p" style="padding:0 35px; border-radius:40px;"><i
                                    class="fas fa-paper-plane"></i></button>
                        </form>
                    </main>
                </div>
            </div>

            <!-- BROADCAST -->
            <div id="tab-broadcast" class="hidden">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px;">
                    <div class="card">
                        <span class="info-label">Inbound Payloads: Admin Control</span>
                        <div id="notif-inbound" style="margin-top:20px; display:flex; flex-direction:column; gap:15px;">
                        </div>
                    </div>
                    <div class="card">
                        <span class="info-label">Outbound: Transmit Mentor Broadcast</span>
                        <textarea id="b-text" placeholder="Enter directive payload..."
                            style="height:150px; border-radius:24px;"></textarea>
                        <button onclick="App.sendBroadcast()" class="btn-p"
                            style="width:100%; margin-top:20px; height:60px; justify-content:center; border-radius:20px;">Deploy
                            Transmission</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAL -->
    <div id="modal-bg" class="modal-bg" onclick="if(event.target===this) App.closeModal()">
        <div class="modal-card">
            <div id="modal-content"></div>
        </div>
    </div>

    <!-- FIREBASE SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, addDoc, updateDoc, deleteDoc, serverTimestamp, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBN4o8oj-6DhJb51sGGrcyS8d9SDX7HKWk", authDomain: "students-management-2ec78.firebaseapp.com", projectId: "students-management-2ec78", storageBucket: "students-management-2ec78.firebasestorage.app", messagingSenderId: "649634574508", appId: "1:649634574508:web:d856dbe5bcc112fde0ef09" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'smps-v1';

        const App = {
            state: { user: null, students: [], projects: [], tasks: [], notifications: [], chats: [], activeChat: null, currentTab: 'dashboard' },

            async init() {
                this.init3D();
                setInterval(() => {
                    document.getElementById('live-clock').innerText = new Date().toLocaleTimeString('en-US', { hour12: true });
                }, 1000);

                await signInAnonymously(auth);
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('login-form').onsubmit = (e) => this.handleLogin(e);
                document.getElementById('chat-form').onsubmit = (e) => this.sendChat(e);
                window.App = this;
            },

            async handleLogin(e) {
                e.preventDefault();
                const u = document.getElementById('l-user').value.trim();
                const p = document.getElementById('l-pass').value;
                const btn = e.target.querySelector('button');
                btn.innerText = 'SYNCING NODE...';

                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'mentors'), snap => {
                    const match = snap.docs.find(d => (d.data().email === u || d.data().name === u) && d.data().spec === p);
                    if (match) {
                        this.state.user = { id: match.id, ...match.data() };
                        this.enterPortal();
                    } else {
                        document.getElementById('login-error').classList.remove('hidden');
                        btn.innerText = 'AUTHORIZE HUB';
                    }
                }, { once: true });
            },

            enterPortal() {
                document.getElementById('view-login').classList.add('hidden');
                document.getElementById('view-portal').classList.remove('hidden');
                document.getElementById('u-name').innerText = this.state.user.name;
                document.getElementById('u-avatar').innerText = this.state.user.name[0];
                this.sync();
            },

            sync() {
                const targets = ['students', 'projects', 'tasks', 'notifications', 'chats'];
                targets.forEach(col => {
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', col), snap => {
                        this.state[col] = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        this.render();
                    });
                });
            },

            switchTab(t) {
                this.state.currentTab = t;
                document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
                document.getElementById(`tab-${t}`).classList.remove('hidden');
                document.getElementById(`nav-${t}`).classList.add('active');
                document.getElementById('view-title').innerText = t === 'teambuilder' ? 'Team Builder' : (t === 'broadcast' ? 'Transmissions' : (t === 'assethub' ? 'Asset Hub' : t.charAt(0).toUpperCase() + t.slice(1).replace('hub', ' Hub')));
                this.render();
            },

            render() {
                const { user, students, projects, tasks, notifications, chats, currentTab } = this.state;
                if (!user) return;

                const myStudents = students.filter(s => s.mentor === user.email);
                const myProjects = projects.filter(p => p.mentor === user.email);
                const myTasks = tasks.filter(t => myStudents.some(s => s.id === t.sid || s.srn === t.sid));

                document.getElementById('stat-students').innerText = myStudents.length;
                document.getElementById('stat-teams').innerText = myProjects.length;
                document.getElementById('stat-pending').innerText = myStudents.filter(s => s.att === 'pending').length;
                document.getElementById('stat-feed').innerText = notifications.length;

                if (currentTab === 'dashboard') {
                    document.getElementById('dash-roster').innerHTML = myStudents.slice(0, 5).map(s => `
                        <div style="padding:12px; background:#fff; border-radius:15px; border:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
                            <span style="font-weight:800; font-size:12px;">${s.name}</span>
                            <span class="badge ${s.att === 'verified' ? 'bg-e' : 'bg-a'}">${s.att}</span>
                        </div>`).join('') || '<p class="info-label">No nodes mapped.</p>';

                    document.getElementById('dash-teams').innerHTML = myProjects.slice(0, 4).map(p => `
                        <div style="padding:12px; background:#fff; border-radius:15px; border:1.5px solid var(--border); margin-bottom:8px;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <p style="font-weight:800; font-size:12px;">${p.teamName}</p>
                                <span class="badge bg-p" style="color:#fff; font-size:8px;">${p.track}</span>
                            </div>
                            <div style="margin-top:10px; display:flex; align-items:center; gap:10px;">
                                <span class="info-label" style="margin:0;">Score:</span>
                                <p style="font-weight:900; font-size:13px; color:var(--primary);">${p.cumulativeScore || 0}/100</p>
                            </div>
                        </div>`).join('');
                }

                if (currentTab === 'attendance') {
                    document.getElementById('att-table-body').innerHTML = myStudents.map(s => `
                        <tr><td><b>${s.srn}</b></td><td>${s.name}</td><td>${s.time || '--:--'}</td>
                        <td><span class="badge ${s.att === 'verified' ? 'bg-e' : 'bg-a'}">${s.att}</span></td>
                        <td><div style="display:flex; gap:10px;">
                            <button onclick="App.setAtt('${s.id}','verified')" class="mark-btn btn-yes"><i class="fas fa-check"></i></button>
                            <button onclick="App.setAtt('${s.id}','absent')" class="mark-btn btn-no"><i class="fas fa-times"></i></button>
                        </div></td></tr>`).join('');
                }

                if (currentTab === 'teambuilder') {
                    document.getElementById('teams-container').innerHTML = myProjects.map(p => `
                        <div class="card">
                            <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:20px;">
                                <div><h4 style="font-weight:900; font-size:1.4rem; letter-spacing:-0.5px;">${p.teamName}</h4><span class="badge bg-p" style="color:#fff;">${p.track}</span></div>
                                <button onclick="App.deleteItem('projects','${p.id}')" style="background:none; border:none; color:var(--rose); cursor:pointer;"><i class="fas fa-trash-can"></i></button>
                            </div>
                            
                            <p class="info-label" style="margin-bottom:8px;">Track Assignment</p>
                            <p style="font-size:12px; font-weight:700; color:var(--slate); margin-bottom:20px;">${p.name}</p>
                            
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                                <div>
                                    <span class="info-label">Proficiency Score (100)</span>
                                    <input type="number" id="score-${p.id}" value="${p.cumulativeScore || 0}" min="0" max="100" style="margin-top:5px; height:50px;">
                                </div>
                                <div>
                                    <span class="info-label">Protocol Reference (PDF)</span>
                                    <input type="file" id="pdf-file-${p.id}" style="margin-top:5px; height:50px; font-size:10px; padding:10px;" accept=".pdf">
                                    <p id="pdf-status-${p.id}" style="font-size:9px; font-weight:800; color:var(--emerald); margin-top:5px;">${p.pdfFileName ? 'ACTIVE: ' + p.pdfFileName : 'AWAITING UPLOAD'}</p>
                                </div>
                            </div>
                            
                            <button onclick="App.updateCluster('${p.id}')" class="btn-p" style="width:100%; margin-top:25px; height:55px; justify-content:center; border-radius:15px;">SYNCHRONIZE TRACK PROGRESS</button>
                        </div>`).join('') || '<p class="info-label" style="grid-column: span 2; text-align:center; padding:50px;">No active team clusters initialized.</p>';
                }

                if (currentTab === 'assethub') {
                    const picker = document.getElementById('asset-student-picker');
                    const currentVal = picker.value;
                    picker.innerHTML = `<option value="">Select Student Node...</option>` + myStudents.map(s => `<option value="${s.id}" ${s.id === currentVal ? 'selected' : ''}>${s.name} (${s.srn})</option>`).join('');
                }

                if (currentTab === 'tasks') {
                    document.getElementById('tasks-grid').innerHTML = myTasks.map(t => {
                        const s = students.find(x => x.id === t.sid || x.srn === t.sid);
                        return `<div class="card" style="border-left: 6px solid ${t.status === 'Done' ? 'var(--emerald)' : 'var(--amber)'}">
                            <span class="info-label">${s?.name || 'NODE'}</span>
                            <h4 style="font-weight:800; font-size:14px; margin-bottom:15px;">${t.desc}</h4>
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <span class="badge ${t.status === 'Done' ? 'bg-e' : 'bg-a'}">${t.status}</span>
                                <small style="font-weight:800; color:var(--slate);">DUE: ${t.due}</small>
                            </div>
                            <button onclick="App.deleteItem('tasks','${t.id}')" style="width:100%; margin-top:20px; background:none; border:1px solid #fee2e2; padding:10px; border-radius:12px; font-size:10px; font-weight:800; color:var(--rose); cursor:pointer;">PURGE DIRECTIVE</button>
                        </div>`;
                    }).join('') || '<p class="info-label" style="grid-column: span 3; text-align:center; padding:50px;">Directive queue clear.</p>';
                }

                if (currentTab === 'sync') {
                    document.getElementById('chat-roster').innerHTML = myStudents.map(s => `
                        <div onclick="App.openChat('${s.id}', '${s.name}')" class="chat-user ${this.state.activeChat === s.id ? 'active' : ''}">
                            ${s.name}
                        </div>`).join('');
                    this.renderSyncWindow();
                }

                if (currentTab === 'broadcast') {
                    const inbound = notifications.filter(n => n.senderRole === 'Admin' || n.senderRole === 'Super Admin');
                    document.getElementById('notif-inbound').innerHTML = inbound.map(n => `
                        <div class="card" style="margin-bottom:15px; padding:20px; border-left:4px solid var(--amber);">
                            <div style="display:flex; justify-content:space-between;">
                                <span class="badge bg-a">${n.senderRole}</span>
                                <small style="font-weight:800;">${n.time}</small>
                            </div>
                            <p style="font-weight:800; margin-top:10px;">${n.from}</p>
                            <p style="font-size:12px; color:var(--slate); margin-top:5px; line-height:1.4;">${n.text}</p>
                        </div>`).join('') || '<p class="info-label">No command syncs.</p>';
                }
            },

            exploreAssets() {
                const sid = document.getElementById('asset-student-picker').value;
                if (!sid) return;
                const s = this.state.students.find(x => x.id === sid);
                const taskLinks = this.state.tasks.filter(t => (t.sid === sid || t.sid === s.srn) && t.payload);
                const projLinks = this.state.projects.filter(p => p.members?.includes(s.name) && p.driveLink);

                document.getElementById('view-title').innerText = `Node Assets: ${s.name}`;
                document.getElementById('asset-results').classList.remove('hidden');

                let html = '';
                if (projLinks.length > 0) {
                    html += `<div class="card" style="grid-column: span 2;"><span class="info-label">Project Technical Deliverables</span>` +
                        projLinks.map(p => `<div class="asset-item"><a href="${p.driveLink}" target="_blank">${p.driveLink}</a><span class="asset-meta">${p.teamName}</span></div>`).join('') + `</div>`;
                }
                if (taskLinks.length > 0) {
                    html += `<div class="card" style="grid-column: span 2;"><span class="info-label">Task Payload Submissions</span>` +
                        taskLinks.map(t => `<div class="asset-item"><a href="${t.payload}" target="_blank">${t.payload}</a><span class="asset-meta">${t.desc.slice(0, 40)}...</span></div>`).join('') + `</div>`;
                }
                if (html === '') html = '<p class="info-label" style="text-align:center; padding:50px; grid-column: span 2; background:#fff; border-radius:20px; border:1px solid var(--border);">No technical assets synchronized for this node identity.</p>';
                ui.html('asset-list-container', html);
            },

            showModal(type) {
                const bg = document.getElementById('modal-bg');
                const content = document.getElementById('modal-content');
                const myStudents = this.state.students.filter(s => s.mentor === this.state.user.email);
                bg.classList.add('active');

                if (type === 'project') {
                    content.innerHTML = `<h3>Initialize Team Cluster</h3>
                        <label class="info-label">Domain Track</label><select id="m-p-track"><option>Track Alpha</option><option>Track Beta</option></select>
                        <label class="info-label" style="margin-top:10px;">Cluster Identity Name</label><input type="text" id="m-p-team" placeholder="e.g. CYBER_UNIT_01">
                        <label class="info-label" style="margin-top:10px;">Research Roadmap Title</label><input type="text" id="m-p-name" placeholder="Smart Energy Matrix v6">
                        <label class="info-label" style="margin-top:10px;">Assign Individual Node Members</label>
                        <div class="check-list">
                            ${myStudents.map((s, i) => `
                                <div class="check-item">
                                    <input type="checkbox" id="node-${i}" value="${s.name}">
                                    <label for="node-${i}">${s.name} (${s.srn})</label>
                                </div>
                            `).join('')}
                        </div>
                        <button onclick="App.addProject()" class="btn-p" style="width:100%; margin-top:25px; height:60px; justify-content:center; border-radius:20px;">Deploy Cluster</button>`;
                } else if (type === 'task') {
                    content.innerHTML = `<h3>Dispatch Technical Directive</h3>
                        <label class="info-label">Target Node</label><select id="m-t-sid">${myStudents.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}</select>
                        <label class="info-label" style="margin-top:10px;">Instruction Payload</label><textarea id="m-t-desc" placeholder="Details..."></textarea>
                        <label class="info-label" style="margin-top:10px;">Deadline Time</label><input type="text" id="m-t-due" placeholder="Today 5:00 PM">
                        <button onclick="App.addTask()" class="btn-p" style="width:100%; margin-top:25px; height:60px; justify-content:center; border-radius:20px;">Transmit Directive</button>`;
                }
            },

            closeModal() { document.getElementById('modal-bg').classList.remove('active'); },

            async addProject() {
                const track = document.getElementById('m-p-track').value;
                const teamName = document.getElementById('m-p-team').value;
                const name = document.getElementById('m-p-name').value;
                const members = Array.from(document.querySelectorAll('.check-item input:checked')).map(c => c.value);
                if (!name || !teamName || members.length === 0) { alert("Missing cluster parameters."); return; }
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'projects'), {
                    track, teamName, name, members,
                    mentor: this.state.user.email,
                    points: Array(24).fill({ status: 'none' }),
                    pdfUrl: '',
                    pdfFileName: '',
                    cumulativeScore: 0,
                    driveLink: ''
                });
                this.closeModal();
            },

            async addTask() {
                const sid = document.getElementById('m-t-sid').value;
                const desc = document.getElementById('m-t-desc').value;
                const due = document.getElementById('m-t-due').value;
                if (!desc) return;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'tasks'), { sid, desc, due, status: 'Pending' });
                this.closeModal();
            },

            async updateCluster(projId) {
                const score = parseInt(document.getElementById(`score-${projId}`).value) || 0;
                const fileInput = document.getElementById(`pdf-file-${projId}`);

                let updateData = { cumulativeScore: Math.min(100, Math.max(0, score)) };

                if (fileInput.files.length > 0) {
                    updateData.pdfFileName = fileInput.files[0].name;
                    // Note: In a real environment, we'd upload to Firebase Storage here.
                    // For this canvas, we synchronize the file intent.
                }

                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'projects', projId), updateData);
                alert("Cluster Progress Synchronized with Student Nodes.");
            },

            async setAtt(id, val) {
                const time = new Date().toLocaleTimeString('en-US', { hour12: true, hour: '2-digit', minute: '2-digit' });
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', id), { att: val, time });
            },

            async deleteItem(col, id) {
                if (confirm("Permanently purge this record from technical ledger?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', col, id));
            },

            async sendBroadcast() {
                const text = document.getElementById('b-text').value;
                if (!text) return;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'notifications'), {
                    from: this.state.user.name,
                    senderRole: 'Mentor',
                    text,
                    time: new Date().toLocaleTimeString([], { hour: 12, hour: '2-digit', minute: '2-digit' })
                });
                document.getElementById('b-text').value = '';
                alert("TRANSMISSION_SUCCESS");
            },

            openChat(id, name) {
                this.state.activeChat = id;
                document.getElementById('chat-target').innerText = name;
                this.renderSyncWindow();
                this.render();
            },

            renderSyncWindow() {
                const win = document.getElementById('chat-window');
                if (!win || !this.state.activeChat) return;
                const msgs = this.state.chats.filter(c => c.channel === this.state.activeChat || c.channel === this.state.user.id);
                win.innerHTML = msgs.map(m => `<div class="bubble ${m.sender === 'Mentor' ? 'bubble-me' : 'bubble-them'}">${m.text}</div>`).join('') || '<p class="info-label" style="text-align:center; padding:30px;">Sync established.</p>';
                win.scrollTop = win.scrollHeight;
            },

            async sendChat(e) {
                e.preventDefault();
                const inp = document.getElementById('chat-input');
                if (!inp.value || !this.state.activeChat) return;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chats'), { channel: this.state.activeChat, text: inp.value, sender: 'Mentor', timestamp: serverTimestamp() });
                inp.value = '';
            },

            init3D() {
                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                document.getElementById('canvas-container').appendChild(renderer.domElement);
                const bubbles = [];
                for (let i = 0; i < 40; i++) {
                    const b = new THREE.Mesh(new THREE.SphereGeometry(1, 32, 32), new THREE.MeshPhongMaterial({ color: 0x4F46E5, transparent: true, opacity: 0.04 }));
                    b.position.set((Math.random() - 0.5) * 180, (Math.random() - 0.5) * 180, (Math.random() - 0.5) * 180);
                    b.userData = { v: new THREE.Vector3((Math.random() - 0.5) * 0.03, (Math.random() - 0.5) * 0.03, (Math.random() - 0.5) * 0.03) };
                    scene.add(b); bubbles.push(b);
                }
                scene.add(new THREE.AmbientLight(0xffffff, 0.9)); camera.position.z = 80;
                const anim = () => { requestAnimationFrame(anim); bubbles.forEach(b => { b.position.add(b.userData.v); if (Math.abs(b.position.x) > 90) b.userData.v.x *= -1; }); renderer.render(scene, camera); };
                anim();
            }
        };

        App.init();
    </script>
</body>

</html>
