<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMPS Tech | Grand Admin Console</title>
    <!-- Premium Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --primary: #6366F1;
            --primary-glow: rgba(99, 102, 241, 0.2);
            --dark: #0F172A;
            --dark-surface: #1E293B;
            --slate: #64748B;
            --bg: #0B0F1A;
            --surface: #161B2B;
            --border: rgba(255, 255, 255, 0.08);
            --emerald: #10B981;
            --amber: #F59E0B;
            --crimson: #EF4444;
            --text-main: #F1F5F9;
            --text-dim: #94A3B8;
            --radius-lg: 16px;
            --radius-xl: 24px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 280px;
            background: var(--surface);
            color: #fff;
            display: flex;
            flex-direction: column;
            padding: 30px 20px;
            flex-shrink: 0;
            border-right: 1px solid var(--border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 40px;
            padding: 0 10px;
        }

        .logo i {
            color: var(--primary);
            font-size: 1.8rem;
        }

        .logo span {
            font-size: 1.3rem;
            font-weight: 800;
            letter-spacing: -1px;
        }

        .nav-label {
            font-size: 10px;
            font-weight: 800;
            color: var(--slate);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin: 20px 0 10px 15px;
        }

        .nav-item {
            padding: 12px 16px;
            border-radius: 12px;
            color: var(--text-dim);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: 0.3s;
            font-size: 0.9rem;
            margin-bottom: 4px;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.03);
            color: #fff;
        }

        .nav-item.active {
            background: var(--primary);
            color: #fff;
            box-shadow: 0 10px 20px var(--primary-glow);
        }

        /* --- Main Content --- */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            background: var(--bg);
        }

        .top-bar {
            height: 70px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 0 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .view-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        /* --- Stats --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 20px;
            transition: 0.3s;
        }

        .stat-card .label {
            font-size: 10px;
            font-weight: 800;
            color: var(--slate);
            text-transform: uppercase;
        }

        .stat-card .value {
            font-size: 1.8rem;
            font-weight: 900;
            margin-top: 5px;
            color: var(--text-main);
        }

        /* --- Panels & Tables --- */
        .panel {
            background: var(--surface);
            border-radius: 20px;
            border: 1px solid var(--border);
            padding: 24px;
            margin-bottom: 24px;
        }

        .panel-h {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 12px;
            overflow: hidden;
        }

        th {
            background: rgba(255, 255, 255, 0.03);
            padding: 14px 20px;
            font-size: 10px;
            font-weight: 800;
            color: var(--slate);
            text-transform: uppercase;
            border-bottom: 1px solid var(--border);
            text-align: left;
        }

        td {
            padding: 16px 20px;
            font-size: 13px;
            font-weight: 600;
            border-bottom: 1px solid var(--border);
            color: var(--text-main);
        }

        tr:last-child td {
            border-bottom: none;
        }

        /* --- Buttons --- */
        .btn {
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            border: none;
            transition: 0.2s;
        }

        .btn-p {
            background: var(--primary);
            color: #fff;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-dim);
        }

        .btn-pdf {
            background: rgba(239, 68, 68, 0.1);
            color: var(--crimson);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        /* --- Ledger Flow --- */
        .ledger-split {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 20px;
        }

        .list-box {
            background: var(--surface);
            border-radius: 20px;
            border: 1px solid var(--border);
            padding: 15px;
            height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .st-item {
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 8px;
            border: 1px solid transparent;
            transition: 0.2s;
        }

        .st-item:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .st-item.active {
            background: var(--primary-glow);
            border-color: var(--primary);
        }

        /* --- Enrollment Modal (as per image) --- */
        .modal-bg {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 5000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-bg.active {
            display: flex;
        }

        .modal-c {
            background: var(--surface);
            border: 1px solid var(--border);
            width: 100%;
            max-width: 650px;
            border-radius: 24px;
            padding: 35px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .enroll-form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 25px;
        }

        .f-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .f-group label {
            font-size: 10px;
            font-weight: 800;
            color: var(--slate);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .f-group input,
        .f-group select,
        .f-group textarea {
            background: #1e293b;
            border: 1px solid rgba(255, 255, 255, 0.05);
            padding: 14px 18px;
            border-radius: 12px;
            color: #fff;
            font-weight: 600;
            outline: none;
        }

        .f-group input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px var(--primary-glow);
        }

        .btn-full {
            grid-column: span 2;
            height: 56px;
            background: #6366f1;
            color: white;
            font-weight: 800;
            border-radius: 14px;
            border: none;
            cursor: pointer;
            margin-top: 20px;
            font-size: 14px;
            letter-spacing: 0.5px;
            transition: 0.3s;
        }

        .btn-full:hover {
            background: #4f46e5;
            transform: scale(1.01);
        }

        /* --- Auth Overlay --- */
        #auth-overlay {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .auth-card {
            background: var(--surface);
            padding: 50px;
            border-radius: 30px;
            text-align: center;
            border: 1px solid var(--border);
            width: 400px;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 9px;
            font-weight: 800;
            text-transform: uppercase;
        }

        .bg-e {
            background: rgba(16, 185, 129, 0.1);
            color: var(--emerald);
        }

        .bg-a {
            background: rgba(245, 158, 11, 0.1);
            color: var(--amber);
        }

        .hidden {
            display: none !important;
        }

        ::-webkit-scrollbar {
            width: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 10px;
        }
    </style>
</head>

<body>

    <div id="auth-overlay">
        <div class="auth-card">
            <i class="fas fa-shield-halved" style="font-size: 3rem; color: var(--primary); margin-bottom: 25px;"></i>
            <h1 style="font-size: 1.8rem; font-weight: 900; margin-bottom: 10px;">Grand Admin</h1>
            <p style="color: var(--slate); font-weight: 600; margin-bottom: 30px;">Initialize Secure Operations Node</p>
            <button id="auth-btn" onclick="App.login()" class="btn btn-p"
                style="width: 100%; height: 55px; justify-content: center;">Initialize Session</button>
        </div>
    </div>

    <div id="app-shell" class="hidden" style="width: 100%; display: flex;">
        <aside class="sidebar">
            <div class="logo"><i class="fas fa-shield-halved"></i><span>SMPS <b>GRAND</b></span></div>

            <nav style="flex: 1; overflow-y: auto;">
                <div class="nav-label">Core Operations</div>
                <div onclick="App.switchTab('dashboard')" class="nav-item active" id="nav-dashboard"><i
                        class="fas fa-chart-line"></i> Dashboard</div>
                <div onclick="App.switchTab('ledger')" class="nav-item" id="nav-ledger"><i
                        class="fas fa-calendar-days"></i> Master Ledger</div>

                <div class="nav-label">Node Management</div>
                <div onclick="App.switchTab('students')" class="nav-item" id="nav-students"><i
                        class="fas fa-user-graduate"></i> Student Roster</div>
                <div onclick="App.switchTab('mentors')" class="nav-item" id="nav-mentors"><i
                        class="fas fa-user-tie"></i> Mentor Fleet</div>

                <div class="nav-label">Revenue Hub</div>
                <div onclick="App.switchTab('finance')" class="nav-item" id="nav-finance"><i class="fas fa-wallet"></i>
                    Financials</div>

                <div class="nav-label">Transmission</div>
                <div onclick="App.switchTab('tasks')" class="nav-item" id="nav-tasks"><i class="fas fa-list-check"></i>
                    Directive Hub</div>
                <div onclick="App.switchTab('broadcast')" class="nav-item" id="nav-broadcast"><i
                        class="fas fa-bullhorn"></i> Global Alert</div>
            </nav>

            <div
                style="margin-top: 20px; padding: 20px; background: rgba(255,255,255,0.02); border-radius: 15px; text-align: center;">
                <button onclick="location.reload()"
                    style="background:none; border:none; color:var(--crimson); font-weight:800; cursor:pointer; font-size: 11px;">TERMINATE
                    SESSION</button>
            </div>
        </aside>

        <main class="main">
            <header class="top-bar">
                <h2 id="view-title" style="font-weight: 900; font-size: 1.4rem;">Command Dashboard</h2>
                <div style="text-align: right;">
                    <p id="live-time" style="font-size: 1.2rem; font-weight: 900;"></p>
                    <p id="live-date"
                        style="font-size: 10px; font-weight: 700; color: var(--slate); text-transform: uppercase;"></p>
                </div>
            </header>

            <div class="view-content">
                <!-- TAB: DASHBOARD -->
                <div id="tab-dashboard">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <p class="label">Total Nodes</p>
                            <h3 id="stat-students" class="value">0</h3>
                        </div>
                        <div class="stat-card">
                            <p class="label">Faculty Sync</p>
                            <h3 id="stat-mentors" class="value">0</h3>
                        </div>
                        <div class="stat-card">
                            <p class="label">Live Directives</p>
                            <h3 id="stat-tasks" class="value">0</h3>
                        </div>
                        <div class="stat-card">
                            <p class="label">Gross Collection</p>
                            <h3 id="stat-fees" class="value" style="color: var(--emerald);">₹0</h3>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 340px; gap: 24px;">
                        <div class="panel">
                            <div class="panel-h">
                                <h4>Recent Node Enrollments</h4>
                            </div>
                            <div id="dash-recent-list" style="display:flex; flex-direction:column; gap:10px;"></div>
                        </div>
                        <div class="panel">
                            <h4 style="margin-bottom:20px;">Faculty Load Distribution</h4>
                            <div id="dash-mentor-load" style="display:flex; flex-direction:column; gap:12px;"></div>
                        </div>
                    </div>
                </div>

                <!-- TAB: STUDENT ROSTER -->
                <div id="tab-students" class="hidden">
                    <div class="panel-h">
                        <h3>Registry Archive</h3>
                        <button onclick="App.showModal('student')" class="btn btn-p">+ Enroll New Node</button>
                    </div>
                    <div class="panel" style="padding:0; overflow:hidden;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Identity / SRN</th>
                                    <th>Branch</th>
                                    <th>Track (Product)</th>
                                    <th>Mentor Assigned</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="students-table"></tbody>
                        </table>
                    </div>
                </div>

                <!-- TAB: LEDGER -->
                <div id="tab-ledger" class="hidden">
                    <div class="ledger-split">
                        <div class="list-box">
                            <input type="text" id="ledger-search" placeholder="Search SRN..."
                                style="width:100%; margin-bottom:15px; background: #111; border: 1px solid var(--border); color:#fff; padding:10px; border-radius:8px;"
                                oninput="App.renderLedgerList()">
                            <div id="ledger-list"></div>
                        </div>
                        <div id="ledger-detail" class="panel">
                            <div style="text-align:center; padding:100px; color:var(--slate);">
                                <i class="fas fa-database" style="font-size:3rem; opacity:0.1; margin-bottom:20px;"></i>
                                <p>Select a node to inspect presence history.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB: MENTORS -->
                <div id="tab-mentors" class="hidden">
                    <div class="panel-h">
                        <h3>Faculty Fleet</h3><button onclick="App.showModal('mentor')" class="btn btn-p">+ Add
                            Faculty</button>
                    </div>
                    <div id="mentors-grid"
                        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;">
                    </div>
                </div>

                <!-- TAB: FINANCE -->
                <div id="tab-finance" class="hidden">
                    <div class="panel-h">
                        <h3>Collection Audit</h3>
                    </div>
                    <div class="panel" style="padding:0; overflow:hidden;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Node Name</th>
                                    <th>Product Track</th>
                                    <th>Contact</th>
                                    <th>Internship Fee</th>
                                    <th>Mentor</th>
                                </tr>
                            </thead>
                            <tbody id="finance-table"></tbody>
                        </table>
                    </div>
                </div>

                <!-- TAB: TASKS -->
                <div id="tab-tasks" class="hidden">
                    <div class="panel-h">
                        <h3>Directives System</h3><button onclick="App.showModal('task')" class="btn btn-p">+ New
                            Directive</button>
                    </div>
                    <div class="panel" style="padding:0; overflow:hidden;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Target Node</th>
                                    <th>Payload Instruction</th>
                                    <th>Deadline</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="tasks-table"></tbody>
                        </table>
                    </div>
                </div>

                <!-- TAB: BROADCAST -->
                <div id="tab-broadcast" class="hidden">
                    <div style="max-width: 600px; margin: 50px auto;" class="panel">
                        <div style="text-align:center; margin-bottom:30px;">
                            <i class="fas fa-tower-broadcast"
                                style="font-size: 3rem; color: var(--primary); margin-bottom: 15px;"></i>
                            <h3>Grand Broadcast</h3>
                            <p style="color:var(--slate); font-size:13px; margin-top:5px;">Reflects instantly on all
                                Student/Mentor dashboards.</p>
                        </div>
                        <textarea id="bc-msg" rows="5" placeholder="Enter administrative broadcast payload..."
                            style="width:100%; background:#111; border:1px solid var(--border); border-radius:12px; padding:15px; color:#fff; font-weight:600;"></textarea>
                        <button onclick="App.sendBroadcast()" class="btn btn-p"
                            style="width:100%; margin-top:20px; height:50px; justify-content:center;">Transmit
                            Pulse</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ENROLLMENT MODAL -->
    <div id="modal-overlay" class="modal-bg" onclick="if(event.target.id==='modal-overlay') App.closeModal()">
        <div class="modal-c" id="modal-content-area">
            <!-- Dynamic Content -->
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, addDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBN4o8oj-6DhJb51sGGrcyS8d9SDX7HKWk",
            authDomain: "students-management-2ec78.firebaseapp.com",
            projectId: "students-management-2ec78",
            storageBucket: "students-management-2ec78.firebasestorage.app",
            messagingSenderId: "649634574508",
            appId: "1:649634574508:web:d856dbe5bcc112fde0ef09"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'smps-v1';

        const App = {
            state: { students: [], mentors: [], tasks: [], notifications: [], currentTab: 'dashboard', selectedLedgerId: null },
            listeners: [],

            async init() {
                this.startClock();
                window.App = this;
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        this.sync();
                        document.getElementById('auth-overlay').classList.add('hidden');
                        document.getElementById('app-shell').classList.remove('hidden');
                    }
                });
            },

            async login() {
                const btn = document.getElementById('auth-btn');
                btn.innerText = "Synchronizing...";
                try { await signInAnonymously(auth); } catch (e) { alert("Auth Failure. Refresh."); }
            },

            startClock() {
                setInterval(() => {
                    const now = new Date();
                    document.getElementById('live-time').innerText = now.toLocaleTimeString('en-US', { hour12: true });
                    document.getElementById('live-date').innerText = now.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
                }, 1000);
            },

            sync() {
                const cols = ['students', 'mentors', 'tasks', 'notifications'];
                cols.forEach(c => {
                    const q = collection(db, 'artifacts', appId, 'public', 'data', c);
                    onSnapshot(q, snap => {
                        this.state[c] = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        this.render();
                    });
                });
            },

            switchTab(t) {
                this.state.currentTab = t;
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                document.querySelectorAll('[id^="tab-"]').forEach(p => p.classList.add('hidden'));
                document.getElementById(`nav-${t}`)?.classList.add('active');
                document.getElementById(`tab-${t}`)?.classList.remove('hidden');
                document.getElementById('view-title').innerText = t.charAt(0).toUpperCase() + t.slice(1) + " Console";
                this.render();
            },

            render() {
                const { students, mentors, tasks, currentTab } = this.state;

                const rev = students.reduce((a, s) => a + (Number(s.fee) || 0), 0);
                document.getElementById('stat-students').innerText = students.length;
                document.getElementById('stat-mentors').innerText = mentors.length;
                document.getElementById('stat-tasks').innerText = tasks.length;
                document.getElementById('stat-fees').innerText = '₹' + rev.toLocaleString();

                if (currentTab === 'dashboard') {
                    document.getElementById('dash-recent-list').innerHTML = students.slice(-5).reverse().map(s => `
                        <div style="background:var(--dark-surface); padding:15px; border-radius:12px; display:flex; justify-content:space-between; align-items:center; border:1px solid var(--border);">
                            <div><p style="font-weight:800; font-size:14px;">${s.name}</p><p style="font-size:10px; color:var(--slate);">${s.srn} • ${s.branch}</p></div>
                            <span class="badge ${s.att === 'verified' ? 'bg-e' : 'bg-a'}">${s.att}</span>
                        </div>`).join('') || '<p style="color:var(--slate);">Waiting for nodes...</p>';

                    document.getElementById('dash-mentor-load').innerHTML = mentors.map(m => {
                        const count = students.filter(s => s.mentor === m.email).length;
                        return `<div style="display:flex; justify-content:space-between; font-size:12px; font-weight:700;"><span>${m.name}</span><span style="color:var(--primary);">${count} Students</span></div>`;
                    }).join('');
                }

                if (currentTab === 'students') {
                    document.getElementById('students-table').innerHTML = students.map(s => `
                        <tr>
                            <td><b>${s.name}</b><br><small style="color:var(--slate);">${s.srn}</small></td>
                            <td>${s.branch}</td><td><span class="badge" style="background:var(--primary-glow); color:var(--primary);">${s.product || '---'}</span></td>
                            <td>${s.mentor?.split('@')[0] || 'Unassigned'}</td>
                            <td><span class="badge ${s.att === 'verified' ? 'bg-e' : 'bg-a'}">${s.att}</span></td>
                            <td>
                                <button onclick="App.viewStudent('${s.id}')" class="btn btn-outline" style="padding:6px 12px; font-size:10px;">Inspect</button>
                                <button onclick="App.deleteItem('students', '${s.id}')" style="background:none; border:none; color:var(--crimson); cursor:pointer; margin-left:10px;"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`).join('');
                }

                if (currentTab === 'mentors') {
                    document.getElementById('mentors-grid').innerHTML = mentors.map(m => `
                        <div class="panel" style="margin-bottom:0; position:relative;">
                            <div style="width:40px; height:40px; background:var(--primary); border-radius:10px; display:flex; align-items:center; justify-content:center; font-weight:900; margin-bottom:15px;">${m.name[0]}</div>
                            <h4 style="font-weight:900;">${m.name}</h4>
                            <p style="font-size:11px; color:var(--slate); font-weight:700; margin-bottom:15px;">${m.email}</p>
                            <span class="badge bg-e">${m.spec || 'Faculty'}</span>
                            <button onclick="App.deleteItem('mentors', '${m.id}')" style="position:absolute; top:20px; right:20px; background:none; border:none; color:var(--slate); cursor:pointer;"><i class="fas fa-times"></i></button>
                        </div>`).join('');
                }

                if (currentTab === 'finance') {
                    document.getElementById('finance-table').innerHTML = students.map(s => `
                        <tr><td><b>${s.name}</b></td><td>${s.product || '---'}</td><td>${s.gmail || '---'}</td><td style="color:var(--emerald); font-weight:800;">₹${Number(s.fee || 0).toLocaleString()}</td><td>${s.mentor || '---'}</td></tr>
                    `).join('');
                }

                if (currentTab === 'tasks') {
                    document.getElementById('tasks-table').innerHTML = tasks.map(t => {
                        const s = students.find(x => x.id === t.sid || x.srn === t.sid);
                        return `<tr><td><b>${s?.name || 'All'}</b></td><td>${t.desc || t.title}</td><td>${t.due || '---'}</td><td><span class="badge ${t.status === 'Done' ? 'bg-e' : 'bg-a'}">${t.status}</span></td><td><button onclick="App.deleteItem('tasks', '${t.id}')" style="background:none; border:none; color:var(--slate); cursor:pointer;"><i class="fas fa-times"></i></button></td></tr>`;
                    }).join('');
                }

                if (currentTab === 'ledger') this.renderLedgerList();
            },

            renderLedgerList() {
                const search = document.getElementById('ledger-search')?.value.toLowerCase() || '';
                const filtered = this.state.students.filter(s => s.name.toLowerCase().includes(search) || s.srn.toLowerCase().includes(search));
                document.getElementById('ledger-list').innerHTML = filtered.map(s => `
                    <div onclick="App.selectLedger('${s.id}')" class="st-item ${this.state.selectedLedgerId === s.id ? 'active' : ''}">
                        <p style="font-weight:800; font-size:13px;">${s.name}</p>
                        <p style="font-size:10px; color:var(--slate); font-weight:700;">${s.srn}</p>
                    </div>`).join('');
            },

            selectLedger(id) {
                this.state.selectedLedgerId = id;
                const s = this.state.students.find(x => x.id === id);
                this.renderLedgerList();
                document.getElementById('ledger-detail').innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:30px;">
                        <div><h3 style="font-weight:900; font-size:1.8rem; letter-spacing:-1px;">${s.name}</h3><p style="color:var(--primary); font-weight:800; font-size:12px;">SRN: ${s.srn}</p></div>
                        <button onclick="App.generatePDF('${s.id}')" class="btn btn-pdf"><i class="fas fa-file-pdf"></i> Export Report</button>
                    </div>
                    <div class="panel" style="background: #111;">
                        <span class="info-label">Presence Cycle History</span>
                        <div style="display:grid; grid-template-columns: repeat(10, 1fr); gap:10px; margin-top:15px;">
                            ${Array.from({ length: 30 }, (_, i) => `<div style="width:100%; aspect-ratio:1; background:${i < 24 ? 'var(--emerald)' : 'rgba(255,255,255,0.05)'}; border-radius:4px;"></div>`).join('')}
                        </div>
                    </div>`;
            },

            showModal(type) {
                const overlay = document.getElementById('modal-overlay');
                const inner = document.getElementById('modal-content-area');
                overlay.classList.add('active');

                if (type === 'student') {
                    inner.innerHTML = `
                        <h2 style="font-weight:900; letter-spacing:-1px;">Enroll New Student Node</h2>
                        <div class="enroll-form-grid">
                            <div class="f-group" style="grid-column: span 2;"><label>Full Legal Name</label><input type="text" id="s-name" placeholder="John Doe"></div>
                            <div class="f-group"><label>SRN / ID</label><input type="text" id="s-srn" placeholder="SRN001"></div>
                            <div class="f-group"><label>Access Key</label><input type="text" id="s-pass" value="studentsmps@123"></div>
                            <div class="f-group"><label>Branch</label><input type="text" id="s-branch" placeholder="Electronics"></div>
                            <div class="f-group"><label>Date of Birth</label><input type="date" id="s-dob"></div>
                            <div class="f-group"><label>Gmail Node</label><input type="email" id="s-gmail" placeholder="name@gmail.com"></div>
                            <div class="f-group"><label>Contact Mobile</label><input type="tel" id="s-phone" placeholder="9876543210"></div>
                            <div class="f-group"><label>Research Track (Product)</label><input type="text" id="s-product" placeholder="Drone Detection"></div>
                            <div class="f-group"><label>Enrollment Fee (₹)</label><input type="number" id="s-fee" placeholder="1000"></div>
                            <div class="f-group" style="grid-column: span 2;"><label>Assign Faculty</label>
                                <select id="s-mentor"><option value="">Select Mentor</option>${this.state.mentors.map(m => `<option value="${m.email}">${m.name}</option>`).join('')}</select>
                            </div>
                            <button onclick="App.addStudent()" class="btn-full">Initialize Node</button>
                        </div>`;
                } else if (type === 'mentor') {
                    inner.innerHTML = `<h3>Faculty Commission</h3><div class="enroll-form-grid" style="grid-template-columns:1fr;"><div class="f-group"><label>Full Name</label><input type="text" id="m-name"></div><div class="f-group"><label>Email</label><input type="email" id="m-email"></div><div class="f-group"><label>Access Code</label><input type="text" id="m-spec" placeholder="mentor@123"></div><button onclick="App.addMentor()" class="btn-full">Sync Mentor</button></div>`;
                } else if (type === 'task') {
                    inner.innerHTML = `<h3>Directive Dispatch</h3><div class="enroll-form-grid" style="grid-template-columns:1fr;"><div class="f-group"><label>Target Node</label><select id="t-sid"><option value="global">All Nodes</option>${this.state.students.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}</select></div><div class="f-group"><label>Instruction Payload</label><textarea id="t-desc" rows="3"></textarea></div><div class="f-group"><label>Deadline</label><input type="text" id="t-due" placeholder="5:00 PM"></div><button onclick="App.addTask()" class="btn-full">Transmit</button></div>`;
                }
            },

            closeModal() { document.getElementById('modal-overlay').classList.remove('active'); },

            async addStudent() {
                const data = {
                    name: document.getElementById('s-name').value,
                    srn: document.getElementById('s-srn').value.toUpperCase(),
                    pass: document.getElementById('s-pass').value,
                    branch: document.getElementById('s-branch').value,
                    dob: document.getElementById('s-dob').value,
                    gmail: document.getElementById('s-gmail').value,
                    phone: document.getElementById('s-phone').value,
                    product: document.getElementById('s-product').value,
                    fee: document.getElementById('s-fee').value,
                    mentor: document.getElementById('s-mentor').value,
                    att: 'pending', time: ''
                };
                if (!data.name || !data.srn) return;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'students'), data);
                this.closeModal();
            },

            async addMentor() {
                const data = { name: document.getElementById('m-name').value, email: document.getElementById('m-email').value, spec: document.getElementById('m-spec').value };
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'mentors'), data);
                this.closeModal();
            },

            async addTask() {
                const data = { sid: document.getElementById('t-sid').value, desc: document.getElementById('t-desc').value, due: document.getElementById('t-due').value, status: 'Pending' };
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'tasks'), data);
                this.closeModal();
            },

            async sendBroadcast() {
                const text = document.getElementById('bc-msg').value;
                if (!text) return;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'notifications'), { from: 'Super Admin', senderRole: 'Super Admin', text, time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) });
                document.getElementById('bc-msg').value = '';
                alert("Grand Transmission Success.");
            },

            async deleteItem(col, id) { if (confirm("Purge node records?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', col, id)); },

            generatePDF(id) {
                const s = this.state.students.find(x => x.id === id);
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFillColor(15, 23, 42); doc.rect(0, 0, 210, 40, 'F');
                doc.setFontSize(22); doc.setTextColor(255, 255, 255); doc.text("SMPS TECH | Presence Report", 20, 25);
                doc.autoTable({
                    startY: 50, head: [['Field', 'Value']],
                    body: [['Name', s.name], ['SRN', s.srn], ['Branch', s.branch], ['Mentor', s.mentor], ['Status', s.att.toUpperCase()]],
                    theme: 'striped', headStyles: { fillColor: [99, 102, 241] }
                });
                doc.save(`SMPS_${s.srn}_Report.pdf`);
            },

            viewStudent(id) {
                const s = this.state.students.find(x => x.id === id);
                const inner = document.getElementById('modal-content-area');
                document.getElementById('modal-overlay').classList.add('active');
                inner.innerHTML = `
                    <h2 style="font-weight:900;">Node Investigation</h2>
                    <div class="enroll-form-grid">
                        <div class="f-group"><label>SRN</label><p>${s.srn}</p></div>
                        <div class="f-group"><label>Passkey</label><p>${s.pass}</p></div>
                        <div class="f-group"><label>DOB</label><p>${s.dob || '---'}</p></div>
                        <div class="f-group"><label>Branch</label><p>${s.branch}</p></div>
                        <div class="f-group"><label>Gmail</label><p>${s.gmail || '---'}</p></div>
                        <div class="f-group"><label>Mobile</label><p>${s.phone || '---'}</p></div>
                        <div class="f-group"><label>Fee Paid</label><p style="color:var(--emerald);">₹${s.fee}</p></div>
                        <div class="f-group"><label>Mentor</label><p>${s.mentor}</p></div>
                    </div>
                    <button onclick="App.closeModal()" class="btn-full">Dismiss</button>`;
            }
        };

        App.init();
    </script>
</body>

</html>
